# Story 1.2: CI/CD Pipeline Setup

**Epic:** Epic 1 - Foundation & Authentication  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** developer,  
**I want** automated testing and deployment pipelines configured,  
**so that** code quality is maintained and deployments are reliable and repeatable.

---

## Acceptance Criteria

1. GitHub Actions workflow created for frontend: runs linting, type checking, and unit tests on pull requests.
2. GitHub Actions workflow created for backend: runs linting, type checking, and pytest on pull requests.
3. Docker images build successfully for both frontend and backend services.
4. Deployment workflow configured to push Docker images to container registry on merge to main branch.
5. Environment variables and secrets properly managed in GitHub repository settings.
6. CI pipeline fails if tests fail or linting errors exist, preventing merge of broken code.

---

## Tasks / Subtasks

- [ ] Create frontend CI workflow (AC: 1)
  - [ ] Create `.github/workflows/ci-frontend.yml`
  - [ ] Configure job to run on pull requests to main
  - [ ] Add step for pnpm install with caching
  - [ ] Add step for ESLint checks
  - [ ] Add step for TypeScript type checking (tsc --noEmit)
  - [ ] Add step for Vitest unit tests
  - [ ] Configure job to fail on any error
  
- [ ] Create backend CI workflow (AC: 2)
  - [ ] Create `.github/workflows/ci-backend.yml`
  - [ ] Configure job to run on pull requests to main
  - [ ] Add step for Python dependency installation
  - [ ] Add step for Ruff linting checks
  - [ ] Add step for mypy type checking
  - [ ] Add step for pytest execution with coverage
  - [ ] Configure PostgreSQL service container for integration tests
  
- [ ] Create Docker build workflows (AC: 3)
  - [ ] Create Dockerfile for frontend (multi-stage build)
  - [ ] Create Dockerfile for backend (multi-stage build)
  - [ ] Test Docker builds locally
  - [ ] Add Docker build step to CI workflows
  
- [ ] Create deployment workflow (AC: 4)
  - [ ] Create `.github/workflows/deploy.yml`
  - [ ] Configure to run on push to main branch
  - [ ] Add Docker image build and push steps
  - [ ] Configure Railway deployment trigger (or container registry push)
  - [ ] Add deployment status notifications
  
- [ ] Configure repository secrets (AC: 5)
  - [ ] Add DATABASE_URL for CI tests
  - [ ] Add container registry credentials (if using Docker Hub/GHCR)
  - [ ] Add Railway deployment token (if applicable)
  - [ ] Document required secrets in README
  
- [ ] Implement branch protection rules (AC: 6)
  - [ ] Enable "Require status checks before merging"
  - [ ] Make CI workflows required checks
  - [ ] Enable "Require branches to be up to date"
  - [ ] Test that broken code cannot be merged

---

## Dev Notes

### CI/CD Architecture (From Architecture Document)

**CI Platform:** GitHub Actions (free for public repos, included in GitHub)

**Deployment Platform:** Railway for MVP
- Automatic deployments from GitHub
- Managed PostgreSQL
- Environment variable management
- Automatic HTTPS/SSL

**Docker Strategy:**
- Multi-stage builds to minimize image size
- Production images exclude development dependencies
- Use .dockerignore to exclude unnecessary files

### GitHub Actions Workflow Structure

**Frontend CI Workflow (.github/workflows/ci-frontend.yml):**
```yaml
name: Frontend CI
on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/frontend/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - Checkout code
      - Setup Node.js 20
      - Setup pnpm with caching
      - Install dependencies
      - Run ESLint
      - Run TypeScript checks
      - Run Vitest tests
```

**Backend CI Workflow (.github/workflows/ci-backend.yml):**
```yaml
name: Backend CI
on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/backend/**'
services:
  postgres:
    image: postgres:16
    env:
      POSTGRES_PASSWORD: testpassword
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - Checkout code
      - Setup Python 3.11
      - Install dependencies
      - Run Ruff linting
      - Run mypy type checking
      - Run pytest with coverage
```

**Deployment Workflow (.github/workflows/deploy.yml):**
```yaml
name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - Build frontend Docker image
      - Build backend Docker image
      - Push images to registry
      - Trigger Railway deployment
```

### Docker Configuration

**Frontend Dockerfile (packages/frontend/Dockerfile):**
- Stage 1: Build - Install dependencies, build Next.js
- Stage 2: Production - Copy build artifacts, install prod dependencies only
- Expose port 3000
- CMD: `pnpm start`

**Backend Dockerfile (packages/backend/Dockerfile):**
- Stage 1: Build - Install Python dependencies
- Stage 2: Production - Copy only necessary files
- Expose port 8000
- CMD: `uvicorn app.main:app --host 0.0.0.0 --port 8000`

### Required GitHub Secrets

Add these in repository Settings → Secrets and variables → Actions:

- `DATABASE_URL_TEST`: PostgreSQL connection for CI tests
- `RAILWAY_TOKEN`: Deployment token (if using Railway CLI)
- `DOCKER_USERNAME`: Container registry username (if using Docker Hub)
- `DOCKER_PASSWORD`: Container registry password
- `JWT_SECRET_KEY`: Secret key for JWT signing (for deployment)

### Branch Protection Configuration

In GitHub repository Settings → Branches → Branch protection rules for `main`:

- ✅ Require a pull request before merging
- ✅ Require status checks to pass before merging
  - Frontend CI
  - Backend CI
- ✅ Require branches to be up to date before merging
- ✅ Do not allow bypassing the above settings

### Performance Considerations

- **Caching:** Use GitHub Actions caching for pnpm and pip to speed up builds
- **Parallelization:** Run frontend and backend CI workflows in parallel
- **Selective Triggers:** Use `paths` filter to only run workflows when relevant files change

---

## Testing

### Testing Standards

**Test Locations:**
- Workflow files: `.github/workflows/`
- Test workflows locally using `act` (GitHub Actions local runner)

**Testing Frameworks:**
- CI validation: Manual testing of workflow execution
- Docker builds: Manual testing with `docker build`

**Testing Requirements for This Story:**

1. **Frontend CI Validation:**
   - [ ] Create test PR with intentional ESLint error → CI must fail
   - [ ] Create test PR with intentional TypeScript error → CI must fail
   - [ ] Create test PR with failing test → CI must fail
   - [ ] Create clean PR → CI must pass

2. **Backend CI Validation:**
   - [ ] Create test PR with Ruff linting errors → CI must fail
   - [ ] Create test PR with mypy type errors → CI must fail
   - [ ] Create test PR with failing pytest → CI must fail
   - [ ] Create clean PR → CI must pass

3. **Docker Build Validation:**
   - [ ] Frontend Docker image builds without errors
   - [ ] Backend Docker image builds without errors
   - [ ] Built images can run successfully
   - [ ] Docker Compose can orchestrate all services

4. **Deployment Workflow Validation:**
   - [ ] Merge to main triggers deployment workflow
   - [ ] Docker images push successfully to registry
   - [ ] Railway receives deployment notification (if configured)

5. **Branch Protection Validation:**
   - [ ] Attempt to merge PR with failing CI → must be blocked
   - [ ] Attempt to merge PR without required reviews → must be blocked
   - [ ] Successful PR with passing CI → merges successfully

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
