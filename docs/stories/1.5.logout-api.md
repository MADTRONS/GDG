# Story 1.5: Student Logout API Endpoint

**Epic:** Epic 1 - Foundation & Authentication  
**Status:** Ready for Review  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student,  
**I want** to securely log out of my session,  
**so that** my account is protected when I'm finished using the platform.

---

## Acceptance Criteria

1. POST /api/auth/logout endpoint created requiring valid JWT authentication.
2. Endpoint clears the httpOnly authentication cookie and returns 200 success response.
3. After logout, subsequent requests to authenticated endpoints return 401 unauthorized.
4. Unit tests verify logout clears session and prevents further authenticated access.

---

## Tasks / Subtasks

- [x] Implement JWT authentication dependency (AC: 1)
  - [x] Create `app/utils/dependencies.py` with `get_current_user` dependency
  - [x] Implement JWT token extraction from cookie
  - [x] Implement JWT token validation and decoding
  - [x] Return user ID and username from token
  - [x] Raise HTTPException 401 if token invalid or missing
  - [x] Write tests for authentication dependency
  
- [x] Create logout endpoint (AC: 1, 2)
  - [x] Add POST /api/auth/logout to auth_router
  - [x] Require authentication using Depends(get_current_user)
  - [x] Create response with cleared cookie (max_age=0)
  - [x] Return success message
  - [x] Handle case where user is already logged out gracefully
  
- [x] Implement cookie clearing logic (AC: 2)
  - [x] Set cookie with same name as login cookie
  - [x] Set max_age=0 to expire cookie immediately
  - [x] Set value to empty string
  - [x] Maintain httpOnly and secure flags
  - [x] Test cookie is removed from browser
  
- [x] Create protected endpoint for testing (AC: 3)
  - [x] Add GET /api/auth/me endpoint (returns current user info)
  - [x] Require authentication using get_current_user dependency
  - [x] Use for testing authentication flow
  - [x] Return user ID and username
  
- [x] Write comprehensive tests (AC: 4)
  - [x] Test logout with valid authentication
  - [x] Test logout clears cookie
  - [x] Test subsequent requests fail after logout
  - [x] Test logout without authentication (edge case)
  - [x] Test /api/auth/me endpoint requires authentication

---

## Dev Notes

### Authentication Dependency Pattern

**get_current_user Implementation:**
```python
from fastapi import Depends, HTTPException, status, Request
from jose import JWTError, jwt

async def get_current_user(request: Request) -> dict:
    """Extract and validate JWT token from cookie"""
    token = request.cookies.get("access_token")
    
    if not token:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    try:
        payload = jwt.decode(
            token,
            settings.JWT_SECRET_KEY,
            algorithms=[settings.JWT_ALGORITHM]
        )
        user_id: str = payload.get("user_id")
        username: str = payload.get("username")
        
        if user_id is None or username is None:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid authentication credentials"
            )
        
        return {"user_id": user_id, "username": username}
    
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials"
        )
```

### Cookie Clearing Mechanism

**Logout Response:**
```python
from fastapi import Response

@auth_router.post("/logout")
async def logout(
    response: Response,
    current_user: dict = Depends(get_current_user)
):
    # Clear the authentication cookie
    response.set_cookie(
        key="access_token",
        value="",
        httponly=True,
        secure=True,  # Only over HTTPS in production
        samesite="lax",
        max_age=0  # Expire immediately
    )
    
    return {"message": "Successfully logged out"}
```

### JWT Stateless Considerations

**Important:** JWTs are stateless - the server doesn't track issued tokens. This means:

1. **Token still valid until expiration:** Even after logout, the JWT token remains valid until its 24-hour expiration if someone has access to it. For MVP, this is acceptable.

2. **Post-MVP improvements:**
   - Implement token blacklist (Redis-based)
   - Shorter token expiration with refresh tokens
   - Token revocation on password change

3. **Current mitigation:** Clearing the cookie prevents the browser from sending the token on subsequent requests, which is sufficient for normal use cases.

### Protected Endpoint Pattern

**Example Protected Route:**
```python
@auth_router.get("/me")
async def get_current_user_info(
    current_user: dict = Depends(get_current_user)
):
    return {
        "user_id": current_user["user_id"],
        "username": current_user["username"]
    }
```

This pattern will be reused for all protected endpoints throughout the application.

### Response Formats

**Logout Success (200 OK):**
```json
{
  "message": "Successfully logged out"
}
```

**Unauthenticated (401 Unauthorized):**
```json
{
  "detail": "Not authenticated"
}
```

**Invalid Token (401 Unauthorized):**
```json
{
  "detail": "Invalid authentication credentials"
}
```

### Source Tree Updates

Files to create/modify:
```
packages/backend/app/
├── utils/
│   └── dependencies.py      # get_current_user and other dependencies
└── routers/
    └── auth.py              # Add logout and /me endpoints
```

---

## Testing

### Testing Standards

**Test Locations:**
- Dependency tests: `tests/test_utils/test_dependencies.py`
- Logout endpoint tests: `tests/test_routers/test_auth.py`

**Testing Framework:**
- pytest 8.0.0 with pytest-asyncio
- FastAPI TestClient
- Mock JWT tokens for testing

**Testing Requirements for This Story:**

1. **Authentication Dependency Tests (`test_utils/test_dependencies.py`):**
   ```python
   @pytest.mark.asyncio
   async def test_get_current_user_valid_token(mock_request):
       # Test successful user extraction from valid token
       
   @pytest.mark.asyncio
   async def test_get_current_user_missing_token(mock_request):
       # Test raises 401 when no token present
       
   @pytest.mark.asyncio
   async def test_get_current_user_invalid_token(mock_request):
       # Test raises 401 when token is malformed
       
   @pytest.mark.asyncio
   async def test_get_current_user_expired_token(mock_request):
       # Test raises 401 when token is expired
   ```

2. **Logout Endpoint Tests (`test_routers/test_auth.py`):**
   ```python
   @pytest.mark.asyncio
   async def test_logout_success(client, authenticated_client):
       # Login first, then logout
       response = authenticated_client.post("/api/auth/logout")
       assert response.status_code == 200
       assert "message" in response.json()
       
       # Verify cookie is cleared
       cookies = response.cookies
       assert cookies.get("access_token") == "" or "access_token" not in cookies
       
   @pytest.mark.asyncio
   async def test_logout_without_authentication(client):
       # Attempt logout without being logged in
       response = client.post("/api/auth/logout")
       assert response.status_code == 401
       
   @pytest.mark.asyncio
   async def test_logout_clears_session(client, test_user):
       # Login
       login_response = client.post("/api/auth/login", json={
           "username": test_user.username,
           "password": "testpassword"
       })
       assert login_response.status_code == 200
       
       # Logout
       logout_response = client.post("/api/auth/logout")
       assert logout_response.status_code == 200
       
       # Try to access protected endpoint
       me_response = client.get("/api/auth/me")
       assert me_response.status_code == 401
   ```

3. **Protected Endpoint Tests (`test_routers/test_auth.py`):**
   ```python
   @pytest.mark.asyncio
   async def test_me_endpoint_authenticated(client, authenticated_client):
       response = authenticated_client.get("/api/auth/me")
       assert response.status_code == 200
       assert "user_id" in response.json()
       assert "username" in response.json()
       
   @pytest.mark.asyncio
   async def test_me_endpoint_unauthenticated(client):
       response = client.get("/api/auth/me")
       assert response.status_code == 401
   ```

4. **Test Fixtures:**
   ```python
   @pytest.fixture
   def authenticated_client(client, test_user):
       """Returns a test client with authentication cookie set"""
       # Login and return client with auth cookie
       
   @pytest.fixture
   def valid_jwt_token():
       """Returns a valid JWT token for testing"""
       # Generate test token
   ```

5. **Integration Tests:**
   - [ ] Full authentication flow: login → access protected resource → logout → fail to access
   - [ ] Multiple login/logout cycles work correctly
   - [ ] Logout from one device doesn't affect other sessions (future when implementing refresh tokens)

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes
- Implemented JWT authentication dependency in `app/utils/dependencies.py`
- Created `get_current_user` dependency for extracting and validating JWT tokens from cookies
- Added POST /api/auth/logout endpoint that clears authentication cookie
- Added GET /api/auth/me endpoint for testing authentication flow
- Updated config to support conditional secure flag based on environment (secure=True only in production)
- All 44 tests pass including 6 new tests for authentication dependency, 8 new tests for logout/me endpoints, and 2 integration tests
- Linting passes with no issues

### File List
**Created:**
- packages/backend/app/utils/dependencies.py
- packages/backend/tests/test_utils/test_dependencies.py

**Modified:**
- packages/backend/app/config.py (added environment setting)
- packages/backend/app/routers/auth.py (added logout and /me endpoints, imported get_current_user)
- packages/backend/tests/test_routers/test_auth.py (added 8 new tests for logout and /me endpoints)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-20 | 1.1 | Implementation completed | James (Dev) |
