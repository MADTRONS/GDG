# Story 1.8: Deployment and Environment Configuration

**Epic:** Epic 1 - Foundation & Authentication  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** developer,  
**I want** the MVP authentication system deployable to a production environment,  
**so that** we can begin user testing and iterate based on real feedback.

---

## Acceptance Criteria

1. Docker Compose configuration builds and runs both frontend and backend services locally with database.
2. Environment-specific configuration documented in README for local, staging, and production environments.
3. Production deployment guide created covering: database migration, environment variable setup, SSL/TLS configuration, logging setup.
4. Health check endpoints responding successfully in deployed environment.
5. HTTPS enabled with valid SSL certificate for production domain.
6. Basic monitoring configured to alert on service downtime or error rate spikes.

---

## Tasks / Subtasks

- [ ] Finalize Docker Compose configuration (AC: 1)
  - [ ] Verify all services defined (postgres, backend, frontend)
  - [ ] Configure service dependencies and health checks
  - [ ] Set up proper networking between services
  - [ ] Configure volume mounts for development
  - [ ] Test full stack startup with `docker-compose up`
  - [ ] Document docker-compose commands in README
  
- [ ] Create production Dockerfiles (AC: 1)
  - [ ] Optimize frontend Dockerfile (multi-stage build)
  - [ ] Optimize backend Dockerfile (multi-stage build)
  - [ ] Minimize image sizes
  - [ ] Configure proper user permissions (non-root)
  - [ ] Test Docker images in production mode
  
- [ ] Document environment configurations (AC: 2)
  - [ ] Create environment variables documentation
  - [ ] Document local development setup
  - [ ] Document staging environment setup (future)
  - [ ] Document production environment requirements
  - [ ] Create .env.example with all variables
  - [ ] Add security notes for production secrets
  
- [ ] Create deployment guide (AC: 3)
  - [ ] Document Railway deployment steps
  - [ ] Create database migration guide
  - [ ] Document environment variable setup in Railway
  - [ ] Add SSL/TLS configuration instructions
  - [ ] Document logging configuration (Loguru setup)
  - [ ] Add rollback procedures
  - [ ] Include troubleshooting section
  
- [ ] Configure Railway deployment (AC: 4, 5)
  - [ ] Create Railway project for backend
  - [ ] Create Railway project for frontend
  - [ ] Set up managed PostgreSQL database
  - [ ] Configure environment variables in Railway
  - [ ] Connect GitHub repository for auto-deployment
  - [ ] Configure custom domain (if available)
  - [ ] Verify HTTPS is enabled (Railway automatic)
  - [ ] Test health endpoints in production
  
- [ ] Set up basic monitoring (AC: 6)
  - [ ] Configure UptimeRobot for uptime monitoring
  - [ ] Set up health check pings every 5 minutes
  - [ ] Configure email/SMS alerts for downtime
  - [ ] Set up Sentry for error tracking
  - [ ] Configure Sentry alerts for error rate spikes
  - [ ] Add basic logging to track requests
  - [ ] Document monitoring dashboard access

---

## Dev Notes

### Deployment Architecture (From Architecture Document)

**Deployment Platform:** Railway (MVP)
- Automatic deployments from GitHub
- Managed PostgreSQL 16.1
- Automatic HTTPS/SSL certificates
- Environment variable management (encrypted)
- Single region deployment (US-based)

**Migration Path:** Railway → AWS/GCP when scale demands

**Rationale:** Railway provides fastest path to production with minimal DevOps overhead. Containerized architecture ensures portability.

### Docker Configuration

**Production Frontend Dockerfile:**
```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm build

# Stage 2: Production
FROM node:20-alpine
WORKDIR /app

RUN npm install -g pnpm

# Copy package files and install production dependencies only
COPY --from=builder /app/package.json /app/pnpm-lock.yaml ./
RUN pnpm install --prod --frozen-lockfile

# Copy build artifacts
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public

# Run as non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001
USER nextjs

EXPOSE 3000

CMD ["pnpm", "start"]
```

**Production Backend Dockerfile:**
```dockerfile
# Stage 1: Build
FROM python:3.11-slim AS builder
WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# Stage 2: Production
FROM python:3.11-slim
WORKDIR /app

# Copy dependencies from builder
COPY --from=builder /root/.local /root/.local

# Copy application code
COPY . .

# Create non-root user
RUN useradd -m -u 1001 appuser
USER appuser

# Make sure scripts are in PATH
ENV PATH=/root/.local/bin:$PATH

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**Docker Compose (Development):**
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: counseling
      POSTGRES_PASSWORD: devpassword
      POSTGRES_DB: counseling_platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U counseling"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build: ./packages/backend
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://counseling:devpassword@postgres:5432/counseling_platform
    env_file:
      - ./packages/backend/.env
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./packages/backend:/app

  frontend:
    build: ./packages/frontend
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_BASE_URL: http://localhost:8000/api/v1
    volumes:
      - ./packages/frontend:/app
      - /app/node_modules
      - /app/.next

volumes:
  postgres_data:
```

### Environment Variables Documentation

**Required Environment Variables (.env.example):**
```bash
# ======================
# DATABASE CONFIGURATION
# ======================
DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname

# Local development
# DATABASE_URL=postgresql+asyncpg://counseling:devpassword@localhost:5432/counseling_platform

# Production (Railway provides this automatically)
# DATABASE_URL=postgresql+asyncpg://user:pass@host.railway.app:5432/railway

# ======================
# JWT CONFIGURATION
# ======================
# Generate with: openssl rand -hex 32
JWT_SECRET_KEY=your-secret-key-minimum-32-characters
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# ======================
# EXTERNAL SERVICES
# ======================
# Daily.co (Voice calling)
DAILY_API_KEY=your-daily-api-key

# LiveKit (Video calling)
LIVEKIT_API_KEY=your-livekit-api-key
LIVEKIT_API_SECRET=your-livekit-api-secret

# Beyond Presence (Avatar)
BEYOND_PRESENCE_API_KEY=your-beyond-presence-key

# Deepgram (Speech-to-Text)
DEEPGRAM_API_KEY=your-deepgram-key

# Cartesia (Text-to-Speech)
CARTESIA_API_KEY=your-cartesia-key

# Google Gemini (Primary LLM)
GOOGLE_API_KEY=your-gemini-key

# OpenAI (Fallback LLM)
OPENAI_API_KEY=your-openai-key

# ======================
# MONITORING
# ======================
# Sentry (Error tracking)
SENTRY_DSN=your-sentry-dsn

# ======================
# FRONTEND CONFIGURATION
# ======================
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000/api/v1

# Production
# NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com/api/v1

# ======================
# ENVIRONMENT
# ======================
ENVIRONMENT=development  # development | staging | production
```

### Railway Deployment Steps

**1. Create Railway Projects:**
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Create project
railway init

# Add PostgreSQL
railway add postgresql
```

**2. Configure Environment Variables:**
- Navigate to Railway dashboard
- Select backend service → Variables
- Add all required environment variables
- Railway automatically provides DATABASE_URL for PostgreSQL

**3. Connect GitHub Repository:**
- Settings → Connect Repository
- Select GitHub repository
- Configure auto-deploy on push to main branch

**4. Run Database Migrations:**
```bash
# Connect to Railway project
railway link

# Run migrations
railway run alembic upgrade head
```

**5. Configure Custom Domain (Optional):**
- Settings → Domains
- Add custom domain
- Update DNS records as instructed
- HTTPS automatically configured

### Database Migration Strategy

**Development:**
```bash
# Create new migration
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head

# Rollback
alembic downgrade -1
```

**Production:**
```bash
# Via Railway CLI
railway run alembic upgrade head

# Or via Railway dashboard
# → Service → Deploy → Custom Start Command
# alembic upgrade head && uvicorn app.main:app
```

### Logging Configuration

**Backend Logging (Loguru):**
```python
from loguru import logger
import sys

# Configure logging
logger.remove()  # Remove default handler
logger.add(
    sys.stdout,
    format="{time:YYYY-MM-DD HH:mm:ss} | {level} | {message}",
    level="INFO" if settings.ENVIRONMENT == "production" else "DEBUG",
    serialize=True,  # JSON format for production
)

# Log request/response
logger.info(f"Request: {method} {path}")
logger.error(f"Error: {error}")
```

**Frontend Logging:**
```typescript
// Custom logger for production
const logger = {
  info: (message: string, data?: any) => {
    if (process.env.NODE_ENV === 'production') {
      // Send to logging service
    } else {
      console.log(message, data);
    }
  },
  error: (message: string, error?: any) => {
    console.error(message, error);
    // Send to Sentry
  },
};
```

### Monitoring Setup

**UptimeRobot Configuration:**
1. Create account at uptimerobot.com
2. Add monitor:
   - Type: HTTPS
   - URL: https://your-backend.railway.app/health
   - Interval: 5 minutes
3. Configure alerts:
   - Email notification on downtime
   - SMS notification for critical issues

**Sentry Configuration:**
```python
# Backend (FastAPI)
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

if settings.SENTRY_DSN:
    sentry_sdk.init(
        dsn=settings.SENTRY_DSN,
        environment=settings.ENVIRONMENT,
        traces_sample_rate=0.1,  # 10% of transactions
        integrations=[FastApiIntegration()],
    )
```

```typescript
// Frontend (Next.js)
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});
```

### Rollback Procedures

**Railway Rollback:**
1. Navigate to Deployments in Railway dashboard
2. Find previous successful deployment
3. Click "Rollback to this deployment"
4. Confirm rollback

**Database Rollback:**
```bash
# Rollback one migration
railway run alembic downgrade -1

# Rollback to specific version
railway run alembic downgrade <revision>
```

### Performance Metrics (From Architecture Document)

**Target SLAs:**
- Uptime: 99.5%
- Connection Time: <30 seconds
- API Response Time: <500ms (p95)
- Page Load Time: <3 seconds

**Monitoring Tools:**
- UptimeRobot: Uptime monitoring
- Sentry: Error tracking and performance
- Railway Metrics: Resource usage (CPU, memory, requests)

---

## Testing

### Testing Standards

**Test Locations:**
- Deployment tests: Manual verification
- Docker tests: Manual verification
- Monitoring tests: Manual verification

**Testing Requirements for This Story:**

1. **Local Docker Compose Tests:**
   ```bash
   # Build and start all services
   docker-compose up --build
   
   # Verify services are running
   docker-compose ps
   
   # Check logs
   docker-compose logs backend
   docker-compose logs frontend
   
   # Test health endpoint
   curl http://localhost:8000/health
   
   # Test frontend
   curl http://localhost:3000
   
   # Cleanup
   docker-compose down -v
   ```
   - [ ] All services start successfully
   - [ ] Health check returns healthy status
   - [ ] Frontend accessible on port 3000
   - [ ] Backend accessible on port 8000
   - [ ] Database migrations run successfully

2. **Production Deployment Tests:**
   - [ ] Railway projects created successfully
   - [ ] GitHub repository connected
   - [ ] Environment variables configured
   - [ ] Database provisioned and accessible
   - [ ] Migrations run successfully in production
   - [ ] Health endpoint returns 200 OK
   - [ ] Frontend loads successfully
   - [ ] HTTPS enabled with valid certificate
   - [ ] API requests work from frontend to backend

3. **Environment Configuration Tests:**
   - [ ] .env.example contains all required variables
   - [ ] README documents environment setup
   - [ ] Deployment guide is complete and accurate
   - [ ] Secrets are not committed to repository
   - [ ] Different environments use different configs

4. **Monitoring Tests:**
   - [ ] UptimeRobot pings health endpoint every 5 minutes
   - [ ] Email alert received when service goes down
   - [ ] Sentry captures and reports errors
   - [ ] Sentry alerts configured for error rate spikes
   - [ ] Railway metrics show service health

5. **Security Tests:**
   - [ ] HTTPS enforced (HTTP redirects to HTTPS)
   - [ ] Security headers present in responses
   - [ ] Secrets not exposed in logs or responses
   - [ ] Database not publicly accessible
   - [ ] CORS configured correctly

6. **Performance Tests:**
   - [ ] Health endpoint responds in <500ms
   - [ ] Frontend page loads in <3 seconds
   - [ ] API endpoints respond in <500ms (p95)
   - [ ] Database queries optimized (no N+1)

7. **Rollback Tests:**
   - [ ] Can rollback to previous deployment in Railway
   - [ ] Can rollback database migrations
   - [ ] Rollback completes within 5 minutes
   - [ ] Service remains available during rollback

8. **Documentation Tests:**
   - [ ] Follow deployment guide step-by-step
   - [ ] Verify all steps are accurate
   - [ ] Verify no steps are missing
   - [ ] Update guide with any corrections

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |