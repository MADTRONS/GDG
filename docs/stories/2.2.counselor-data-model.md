# Story 2.2: Counselor Category Data Model

**Epic:** Epic 2 - Counselor Dashboard & Category Management  
**Status:** Complete ✅  
**Created:** December 20, 2025  
**Last Updated:** December 21, 2025  
**Agent Model Used:** Claude Sonnet 4.5

---

## Story

**As a** backend developer,  
**I want** counselor categories defined in the system,  
**so that** the frontend can display accurate, consistent counselor information.

---

## Acceptance Criteria

1. Counselor category configuration defined in backend (YAML, JSON, or database table) with fields: id, name, description, icon_name, enabled.
2. Minimum six categories configured: Health, Career, Academic, Financial, Social, Personal Development.
3. Each category includes a 1-2 sentence description of the counselor's specialty.
4. GET /api/counselors/categories endpoint returns list of enabled categories as JSON.
5. Endpoint accessible only to authenticated users (requires valid JWT).
6. Unit tests verify endpoint returns expected category data structure.

---

## Tasks / Subtasks

- [x] Verify CounselorCategory model exists (AC: 1)
  - [x] Check `app/models/counselor_category.py` from architecture
  - [x] Verify model has fields: id, name, description, icon_name, enabled, created_at, updated_at
  - [x] If not exists, create SQLAlchemy model
  - [x] Create Alembic migration for counselor_categories table
  
- [x] Seed database with six categories (AC: 2, 3)
  - [x] Create seed data script or migration
  - [x] Define Health category with description
  - [x] Define Career category with description
  - [x] Define Academic category with description
  - [x] Define Financial category with description
  - [x] Define Social category with description
  - [x] Define Personal Development category with description
  - [x] Assign appropriate icon names for each
  - [x] Set all categories to enabled=True
  
- [x] Create counselor repository (AC: 4)
  - [x] Create `app/repositories/counselor_repository.py`
  - [x] Implement `get_enabled_categories()` method
  - [x] Use async SQLAlchemy query
  - [x] Order categories by name alphabetically
  - [x] Handle database errors gracefully
  
- [x] Create counselor router and endpoint (AC: 4, 5)
  - [x] Create `app/routers/counselors.py`
  - [x] Implement GET /categories endpoint
  - [x] Require authentication using get_current_user dependency
  - [x] Call counselor repository to fetch categories
  - [x] Return JSON response with category list
  - [x] Register router in main.py with `/api/counselors` prefix
  
- [x] Create response schemas (AC: 4)
  - [x] Create `app/schemas/counselor.py`
  - [x] Define CounselorCategoryResponse Pydantic model
  - [x] Include fields: id, name, description, icon_name
  - [x] Exclude enabled and timestamp fields from response
  - [x] Use Pydantic Config for ORM mode
  
- [x] Write comprehensive tests (AC: 6)
  - [x] Test get_enabled_categories repository method
  - [x] Test GET /categories endpoint with authentication
  - [x] Test endpoint returns only enabled categories
  - [x] Test endpoint requires authentication (401 without JWT)
  - [x] Test response structure matches schema
  - [x] Test categories are ordered alphabetically

---

## Dev Notes

### Data Model (From Architecture Document)

**CounselorCategory Model Fields:**
- `id`: UUID (primary key)
- `name`: VARCHAR(100), unique
- `description`: TEXT
- `icon_name`: VARCHAR(50) - Icon identifier for UI
- `enabled`: BOOLEAN (default: TRUE)
- `created_at`: TIMESTAMP WITH TIME ZONE
- `updated_at`: TIMESTAMP WITH TIME ZONE

**Note:** The architecture document includes a `system_prompt` field for LLM prompts. For this MVP dashboard story, we'll focus on the display fields. The system_prompt will be used in Epics 3 & 4 for actual calling functionality.

### SQLAlchemy Model Implementation

**app/models/counselor_category.py:**
```python
from sqlalchemy import Boolean, String, Text, DateTime
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.sql import func
import uuid
from app.models.base import Base

class CounselorCategory(Base):
    __tablename__ = "counselor_categories"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), unique=True, nullable=False, index=True)
    description = Column(Text, nullable=False)
    icon_name = Column(String(50), nullable=False)
    enabled = Column(Boolean, default=True, nullable=False, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    
    def __repr__(self):
        return f"<CounselorCategory(name='{self.name}', enabled={self.enabled})>"
```

### Seed Data for Six Categories

**Alembic migration or seed script:**
```python
from datetime import datetime
import uuid

def seed_counselor_categories():
    categories = [
        {
            "id": uuid.uuid4(),
            "name": "Health",
            "description": "Mental health, stress management, wellness, and self-care support. Get help with anxiety, depression, sleep issues, and maintaining overall well-being.",
            "icon_name": "heart-pulse",
            "enabled": True,
        },
        {
            "id": uuid.uuid4(),
            "name": "Career",
            "description": "Career exploration, job search strategies, resume help, and interview preparation. Plan your professional future with expert guidance.",
            "icon_name": "briefcase",
            "enabled": True,
        },
        {
            "id": uuid.uuid4(),
            "name": "Academic",
            "description": "Study strategies, time management, course selection, and academic planning. Improve your learning effectiveness and achieve academic success.",
            "icon_name": "graduation-cap",
            "enabled": True,
        },
        {
            "id": uuid.uuid4(),
            "name": "Financial",
            "description": "Budgeting, student loans, financial aid, and money management. Build healthy financial habits and navigate college expenses confidently.",
            "icon_name": "dollar-sign",
            "enabled": True,
        },
        {
            "id": uuid.uuid4(),
            "name": "Social",
            "description": "Relationships, communication skills, campus involvement, and social well-being. Navigate friendships, roommate conflicts, and build meaningful connections.",
            "icon_name": "users",
            "enabled": True,
        },
        {
            "id": uuid.uuid4(),
            "name": "Personal Development",
            "description": "Goal setting, self-awareness, life skills, and personal growth. Discover your strengths, values, and create a roadmap for your future.",
            "icon_name": "star",
            "enabled": True,
        },
    ]
    
    return categories
```

### Icon Mapping

**Lucide React Icon Names:**
- `heart-pulse` → HeartPulse
- `briefcase` → Briefcase
- `graduation-cap` → GraduationCap
- `dollar-sign` → DollarSign
- `users` → Users
- `star` → Star

These icons are available in Lucide React library (used with shadcn/ui).

### Repository Implementation

**app/repositories/counselor_repository.py:**
```python
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from app.models.counselor_category import CounselorCategory
from typing import List

class CounselorRepository:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def get_enabled_categories(self) -> List[CounselorCategory]:
        """
        Retrieve all enabled counselor categories, ordered by name.
        
        Returns:
            List of CounselorCategory objects
        """
        stmt = (
            select(CounselorCategory)
            .where(CounselorCategory.enabled == True)
            .order_by(CounselorCategory.name)
        )
        result = await self.session.execute(stmt)
        return result.scalars().all()
    
    async def get_by_id(self, category_id: str) -> CounselorCategory | None:
        """
        Retrieve a counselor category by ID.
        
        Args:
            category_id: UUID of the category
            
        Returns:
            CounselorCategory object or None
        """
        stmt = select(CounselorCategory).where(CounselorCategory.id == category_id)
        result = await self.session.execute(stmt)
        return result.scalar_one_or_none()
```

### Response Schema

**app/schemas/counselor.py:**
```python
from pydantic import BaseModel, UUID4
from typing import List

class CounselorCategoryResponse(BaseModel):
    """Response schema for counselor category."""
    id: UUID4
    name: str
    description: str
    icon_name: str
    
    class Config:
        from_attributes = True  # Pydantic v2 (was orm_mode in v1)

class CounselorCategoriesResponse(BaseModel):
    """Response schema for list of counselor categories."""
    categories: List[CounselorCategoryResponse]
    total: int
```

### Router Implementation

**app/routers/counselors.py:**
```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db
from app.repositories.counselor_repository import CounselorRepository
from app.schemas.counselor import CounselorCategoryResponse, CounselorCategoriesResponse
from app.utils.dependencies import get_current_user
from typing import Dict

router = APIRouter(prefix="/counselors", tags=["counselors"])

async def get_counselor_repository(session: AsyncSession = Depends(get_db)):
    return CounselorRepository(session)

@router.get(
    "/categories",
    response_model=CounselorCategoriesResponse,
    summary="Get all enabled counselor categories",
    description="Retrieve list of available counselor categories for the dashboard."
)
async def get_categories(
    current_user: Dict = Depends(get_current_user),
    repo: CounselorRepository = Depends(get_counselor_repository)
):
    """
    Get all enabled counselor categories.
    
    Requires authentication.
    
    Returns:
        List of counselor categories with id, name, description, and icon_name.
    """
    categories = await repo.get_enabled_categories()
    
    return CounselorCategoriesResponse(
        categories=[CounselorCategoryResponse.from_orm(cat) for cat in categories],
        total=len(categories)
    )
```

**Register router in main.py:**
```python
from app.routers import auth, health, counselors

app.include_router(auth.router, prefix="/api/v1")
app.include_router(health.router, prefix="/api/v1")
app.include_router(counselors.router, prefix="/api/v1")  # Add this line
```

### API Response Format

**Success Response (200 OK):**
```json
{
  "categories": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Academic",
      "description": "Study strategies, time management, course selection, and academic planning. Improve your learning effectiveness and achieve academic success.",
      "icon_name": "graduation-cap"
    },
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "name": "Career",
      "description": "Career exploration, job search strategies, resume help, and interview preparation. Plan your professional future with expert guidance.",
      "icon_name": "briefcase"
    }
    // ... 4 more categories
  ],
  "total": 6
}
```

**Unauthorized (401):**
```json
{
  "detail": "Not authenticated"
}
```

### Source Tree Updates

New files to create:
```
packages/backend/app/
├── models/
│   └── counselor_category.py     # CounselorCategory model
├── repositories/
│   └── counselor_repository.py   # Category data access
├── schemas/
│   └── counselor.py              # Category response schemas
└── routers/
    └── counselors.py             # Category endpoints
```

---

## Testing

### Testing Standards

**Test Locations:**
- Model tests: `tests/test_models/test_counselor_category.py`
- Repository tests: `tests/test_repositories/test_counselor_repository.py`
- Router tests: `tests/test_routers/test_counselors.py`

**Testing Framework:**
- pytest 8.0.0 with pytest-asyncio
- FastAPI TestClient
- SQLAlchemy test fixtures

**Testing Requirements for This Story:**

1. **Model Tests:**
   ```python
   @pytest.mark.asyncio
   async def test_create_counselor_category(db_session):
       category = CounselorCategory(
           name="Test Category",
           description="Test description",
           icon_name="test-icon",
           enabled=True
       )
       db_session.add(category)
       await db_session.commit()
       
       assert category.id is not None
       assert category.name == "Test Category"
       assert category.enabled is True
   
   @pytest.mark.asyncio
   async def test_unique_category_name(db_session):
       # Test duplicate name raises error
       category1 = CounselorCategory(name="Health", description="Test", icon_name="test")
       category2 = CounselorCategory(name="Health", description="Test2", icon_name="test2")
       
       db_session.add(category1)
       await db_session.commit()
       
       db_session.add(category2)
       with pytest.raises(IntegrityError):
           await db_session.commit()
   ```

2. **Repository Tests:**
   ```python
   @pytest.mark.asyncio
   async def test_get_enabled_categories(db_session, seed_categories):
       repo = CounselorRepository(db_session)
       categories = await repo.get_enabled_categories()
       
       assert len(categories) == 6
       assert all(cat.enabled for cat in categories)
       # Verify alphabetical order
       names = [cat.name for cat in categories]
       assert names == sorted(names)
   
   @pytest.mark.asyncio
   async def test_get_enabled_categories_excludes_disabled(db_session):
       # Create one enabled and one disabled category
       enabled_cat = CounselorCategory(
           name="Enabled", description="Test", icon_name="test", enabled=True
       )
       disabled_cat = CounselorCategory(
           name="Disabled", description="Test", icon_name="test", enabled=False
       )
       db_session.add_all([enabled_cat, disabled_cat])
       await db_session.commit()
       
       repo = CounselorRepository(db_session)
       categories = await repo.get_enabled_categories()
       
       assert len(categories) == 1
       assert categories[0].name == "Enabled"
   
   @pytest.mark.asyncio
   async def test_get_by_id(db_session, seed_categories):
       category = seed_categories[0]
       repo = CounselorRepository(db_session)
       
       found = await repo.get_by_id(category.id)
       
       assert found is not None
       assert found.id == category.id
       assert found.name == category.name
   ```

3. **Router Tests:**
   ```python
   @pytest.mark.asyncio
   async def test_get_categories_success(client, authenticated_headers, seed_categories):
       response = client.get(
           "/api/v1/counselors/categories",
           headers=authenticated_headers
       )
       
       assert response.status_code == 200
       data = response.json()
       
       assert "categories" in data
       assert "total" in data
       assert data["total"] == 6
       assert len(data["categories"]) == 6
       
       # Verify structure of first category
       category = data["categories"][0]
       assert "id" in category
       assert "name" in category
       assert "description" in category
       assert "icon_name" in category
       assert "enabled" not in category  # Should not be in response
   
   @pytest.mark.asyncio
   async def test_get_categories_requires_authentication(client):
       response = client.get("/api/v1/counselors/categories")
       
       assert response.status_code == 401
       assert response.json()["detail"] == "Not authenticated"
   
   @pytest.mark.asyncio
   async def test_categories_ordered_alphabetically(client, authenticated_headers, seed_categories):
       response = client.get(
           "/api/v1/counselors/categories",
           headers=authenticated_headers
       )
       
       categories = response.json()["categories"]
       names = [cat["name"] for cat in categories]
       
       assert names == sorted(names)
       assert names == [
           "Academic", "Career", "Financial", 
           "Health", "Personal Development", "Social"
       ]
   ```

4. **Integration Tests:**
   ```python
   @pytest.mark.asyncio
   async def test_full_flow_login_and_get_categories(client, test_user):
       # Login
       login_response = client.post("/api/v1/auth/login", json={
           "username": test_user.username,
           "password": "testpassword"
       })
       assert login_response.status_code == 200
       
       # Get categories with auth cookie
       categories_response = client.get("/api/v1/counselors/categories")
       assert categories_response.status_code == 200
       
       data = categories_response.json()
       assert data["total"] == 6
   ```

5. **Test Fixtures:**
   ```python
   @pytest.fixture
   async def seed_categories(db_session):
       """Seed database with six counselor categories."""
       categories_data = seed_counselor_categories()  # From seed script
       
       categories = [
           CounselorCategory(**cat_data) for cat_data in categories_data
       ]
       
       db_session.add_all(categories)
       await db_session.commit()
       
       return categories
   
   @pytest.fixture
   def authenticated_headers(valid_jwt_token):
       """Returns headers with valid JWT token."""
       return {"Authorization": f"Bearer {valid_jwt_token}"}
   ```

6. **Manual Testing Checklist:**
   - [ ] Database migration creates counselor_categories table
   - [ ] Seed script populates six categories
   - [ ] All six categories appear in database
   - [ ] GET /api/v1/counselors/categories returns 200 when authenticated
   - [ ] GET /api/v1/counselors/categories returns 401 without authentication
   - [ ] Response includes all six categories
   - [ ] Categories are ordered alphabetically
   - [ ] Each category has correct icon_name
   - [ ] Descriptions are clear and helpful
   - [ ] Response structure matches schema

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-20 | 1.1 | Backend implementation completed | James (Dev Agent) |
| 2025-12-21 | 1.2 | QA review completed - PASS | Quinn (QA Agent) |

---

## QA Results

### Gate Decision: ✅ PASS
**Quality Score:** 92/100  
**Review Date:** December 21, 2025  
**Reviewer:** Quinn (Test Architect & Quality Advisor)

**Executive Summary:**  
Comprehensive backend implementation with excellent code quality, thorough testing (13/13 passing), and complete requirements coverage. All 6 acceptance criteria met with clear evidence. Ready for frontend integration.

**Requirements Traceability:**
- ✅ AC1: Category configuration defined in database with all required fields
- ✅ AC2: Six categories configured (Health, Career, Academic, Financial, Social, Personal Development)  
- ✅ AC3: All categories have detailed 1-2 sentence descriptions
- ✅ AC4: GET /api/v1/counselors/categories returns JSON with alphabetical ordering
- ✅ AC5: Authentication required (401 without JWT)
- ✅ AC6: 13 comprehensive unit tests verify data structure (100% pass rate)

**Test Results:**
- Repository Tests: 7/7 passing ✅
- Router Tests: 6/6 passing ✅  
- Full Regression: 57/57 tests passing ✅
- Zero regression failures

**Quality Attributes:**
- Security: High (JWT authentication, no sensitive data exposure)
- Performance: High (async patterns, indexed queries, bounded result set)
- Reliability: High (database constraints, transaction safety)
- Maintainability: High (clean architecture, type hints, docstrings)
- Testability: Excellent (comprehensive coverage, clear test structure)

**Risk Assessment:** LOW
- Zero high-impact risks identified
- Minor tech debt items non-blocking (test fixture consolidation, deprecation warnings)
- Migration is additive only, safe rollback available
- No changes to existing endpoints

**Recommendations:**
1. Extract seed_categories() to conftest.py for reusability (15 min)
2. Migrate app/config.py to Pydantic v2 ConfigDict (10 min)
3. Consider adding repository logging for production debugging (30 min)

**Production Readiness:** ✅ READY
- Database migration tested and verified
- API authentication enforced
- Comprehensive test coverage
- Documentation complete

**Cleared for Integration:** Ready for Story 2.3 (Counselor Cards UI Component)

Full gate analysis available at: [docs/qa/gates/2.2.counselor-data-model.yml](../qa/gates/2.2.counselor-data-model.yml)

---

## Dev Agent Record

### Completion Notes

Successfully implemented backend counselor category system with complete data model, repository, API endpoint, and comprehensive testing.

**Key Accomplishments:**
- Created CounselorCategory SQLAlchemy model with UUID primary key, unique name constraint, and proper indexes
- Implemented Alembic migration with seed data for all 6 categories
- Built async repository layer with get_enabled_categories(), get_by_id(), and get_all_categories() methods
- Created authenticated API endpoint at GET /api/v1/counselors/categories returning alphabetically sorted categories
- Implemented Pydantic v2 response schemas excluding internal fields (enabled, timestamps)
- Wrote 13 comprehensive tests (7 repository, 6 router) all passing
- Full regression: 57 backend tests passing

**Technical Details:**
- Fixed multiple docstring syntax errors (escaped quotes) in generated files
- Fixed migration file that incorrectly created table twice (changed from op.create_table to using table reference for bulk_insert)
- Created test fixtures for test_user and authenticated_client to support router integration tests
- All tests use proper async patterns with SQLAlchemy 2.0 syntax
- Categories returned in alphabetical order: Academic, Career, Financial, Health, Personal Development, Social

**Migration:**
- Migration ID: 7c20f740ea75
- Successfully created counselor_categories table with proper constraints and indexes
- Seeded 6 categories with detailed descriptions and Lucide icon names

### Debug Log

**Issues Encountered:**
1. Syntax errors in generated files (escaped docstring quotes) - Fixed by replacing `\"\"\"` with `"""`
2. Migration duplicate table creation - Fixed by using table reference instead of second op.create_table()
3. Test authentication setup - Created test_user and authenticated_client fixtures
4. Username format constraint - Fixed test_user to use proper format `\domain\username`

**All Issues Resolved:** Yes

### File List

**Backend Files Created/Modified:**
- packages/backend/app/models/counselor_category.py (NEW)
- packages/backend/app/models/__init__.py (MODIFIED - added CounselorCategory import)
- packages/backend/app/repositories/counselor_repository.py (NEW)
- packages/backend/app/schemas/counselor.py (NEW)
- packages/backend/app/routers/counselors.py (NEW)
- packages/backend/app/main.py (MODIFIED - registered counselors router)
- packages/backend/alembic/versions/7c20f740ea75_add_counselor_categories_table.py (NEW)
- packages/backend/tests/test_counselor_repository.py (NEW)
- packages/backend/tests/test_counselor_router.py (NEW)
- packages/backend/tests/conftest.py (MODIFIED - added test_user and authenticated_client fixtures)