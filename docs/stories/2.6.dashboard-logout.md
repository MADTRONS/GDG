# Story 2.6: Dashboard Navigation and Logout

**Epic:** Epic 2 - Counselor Dashboard & Category Management  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student,  
**I want** to log out from the dashboard,  
**so that** I can end my session securely when finished.

---

## Acceptance Criteria

1. Logout button in dashboard header calls logout function from authentication context.
2. Logout function invokes POST /api/auth/logout API endpoint and clears local authentication state.
3. After logout completes, user redirected to login page with confirmation message: "You have been logged out."
4. All authenticated API requests fail after logout with 401 responses.
5. Logout button accessible via keyboard (Tab focus, Enter key).

---

## Tasks / Subtasks

- [ ] Verify logout button exists in DashboardHeader (AC: 1)
  - [ ] Confirm button created in Story 2.1
  - [ ] Verify button calls logout from useAuth hook
  - [ ] Test button is visible and clickable
  
- [ ] Verify logout function implementation (AC: 2)
  - [ ] Check logout function in AuthProvider (from Story 1.7)
  - [ ] Confirm it calls POST /api/auth/logout
  - [ ] Confirm it clears user state in context
  - [ ] Test authentication state is cleared
  
- [ ] Add logout confirmation message (AC: 3)
  - [ ] Show toast on login page after logout
  - [ ] Message: "You have been logged out."
  - [ ] Use URL parameter or local storage for message
  - [ ] Display message and clear indicator
  
- [ ] Update login page to show logout message (AC: 3)
  - [ ] Check for logout indicator on mount
  - [ ] Display toast if present
  - [ ] Clear indicator after displaying
  - [ ] Style as informational (not error)
  
- [ ] Verify API authentication after logout (AC: 4)
  - [ ] Test categories endpoint returns 401 after logout
  - [ ] Test any authenticated endpoint fails
  - [ ] Verify cookie is cleared
  - [ ] Test session cannot be resumed
  
- [ ] Verify keyboard accessibility (AC: 5)
  - [ ] Test Tab navigation to logout button
  - [ ] Test Enter key triggers logout
  - [ ] Test Space key triggers logout
  - [ ] Ensure focus indicator is visible

---

## Dev Notes

### Logout Button (Already Implemented in Story 2.1)

**components/dashboard/DashboardHeader.tsx:**
```typescript
'use client';

import { useAuth } from '@/components/auth/AuthProvider';
import { Button } from '@/components/ui/button';
import { LogOut } from 'lucide-react';

export function DashboardHeader() {
  const { user, logout } = useAuth();
  
  // ... other code ...
  
  return (
    <header className="border-b bg-white">
      <div className="container mx-auto px-4 py-4">
        <div className="flex items-center justify-between">
          {/* Logo and Welcome */}
          <div>Welcome, {user?.username}!</div>
          
          {/* Logout Button */}
          <Button
            onClick={logout}
            variant="outline"
            className="gap-2"
            aria-label="Logout"
          >
            <LogOut className="h-4 w-4" />
            Logout
          </Button>
        </div>
      </div>
    </header>
  );
}
```

### Logout Function (Already Implemented in Story 1.7)

**components/auth/AuthProvider.tsx:**
```typescript
const logout = async () => {
  try {
    await fetch(
      `${process.env.NEXT_PUBLIC_API_BASE_URL}/auth/logout`,
      {
        method: 'POST',
        credentials: 'include',
      }
    );
  } catch (error) {
    console.error('Logout failed:', error);
  } finally {
    setUser(null);
    router.push('/?logout=true'); // Add logout parameter
  }
};
```

### Updated Login Page with Logout Message

**app/page.tsx (updated):**
```typescript
'use client';

import { useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { LoginForm } from '@/components/auth/LoginForm';
import { useToast } from '@/components/ui/use-toast';

export default function LoginPage() {
  const searchParams = useSearchParams();
  const { toast } = useToast();
  
  useEffect(() => {
    // Check if user was just logged out
    if (searchParams.get('logout') === 'true') {
      toast({
        title: "Logged Out",
        description: "You have been logged out.",
        duration: 3000,
      });
      
      // Clear the URL parameter
      window.history.replaceState({}, '', '/');
    }
  }, [searchParams, toast]);
  
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="w-full max-w-md">
        <LoginForm />
      </div>
    </div>
  );
}
```

### Alternative: Using Local Storage

If URL parameters cause issues:

**In AuthProvider logout:**
```typescript
const logout = async () => {
  try {
    await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/auth/logout`, {
      method: 'POST',
      credentials: 'include',
    });
  } catch (error) {
    console.error('Logout failed:', error);
  } finally {
    setUser(null);
    localStorage.setItem('logoutMessage', 'true');
    router.push('/');
  }
};
```

**In Login Page:**
```typescript
useEffect(() => {
  const logoutMessage = localStorage.getItem('logoutMessage');
  if (logoutMessage === 'true') {
    toast({
      title: "Logged Out",
      description: "You have been logged out.",
      duration: 3000,
    });
    localStorage.removeItem('logoutMessage');
  }
}, [toast]);
```

### Cookie Verification

**After logout, the httpOnly cookie should:**
- Be cleared (max_age=0 from backend)
- Not be sent with subsequent requests
- Result in 401 responses from authenticated endpoints

**Backend logout endpoint (from Story 1.5):**
```python
@router.post("/logout")
async def logout(
    response: Response,
    current_user: Dict = Depends(get_current_user)
):
    # Clear the authentication cookie
    response.set_cookie(
        key="access_token",
        value="",
        httponly=True,
        secure=True,
        samesite="lax",
        max_age=0  # Expire immediately
    )
    
    return {"message": "Successfully logged out"}
```

### Testing Strategy

**Logout Flow:**
1. User logs in successfully
2. User navigates to dashboard
3. User clicks logout button
4. Backend clears authentication cookie
5. Frontend clears user state
6. User redirected to login page
7. Toast message appears: "You have been logged out."
8. Attempting to access dashboard redirects back to login

**Session Invalidation:**
- After logout, JWT cookie is cleared
- GET /api/counselors/categories returns 401
- Dashboard redirects to login (ProtectedRoute)
- Cannot access authenticated routes

---

## Testing

### Testing Standards

**Test Locations:**
- Integration tests: `__tests__/integration/logout-flow.test.tsx`
- Component tests: `__tests__/components/dashboard/DashboardHeader.test.tsx`
- E2E tests: `e2e/logout.spec.ts` (optional)

**Testing Framework:**
- Vitest 1.2.0
- React Testing Library
- Playwright 1.41.0 (for E2E)

**Testing Requirements for This Story:**

1. **Logout Button Tests:**
   ```typescript
   import { render, screen } from '@testing-library/react';
   import userEvent from '@testing-library/user-event';
   import { DashboardHeader } from '@/components/dashboard/DashboardHeader';
   import { useAuth } from '@/components/auth/AuthProvider';
   
   vi.mock('@/components/auth/AuthProvider');
   
   test('logout button calls logout function', async () => {
     const mockLogout = vi.fn();
     vi.mocked(useAuth).mockReturnValue({
       user: { id: '123', username: '\\COLLEGE\\jdoe', is_blocked: false },
       isAuthenticated: true,
       isLoading: false,
       login: vi.fn(),
       logout: mockLogout,
     });
     
     render(<DashboardHeader />);
     
     const logoutButton = screen.getByRole('button', { name: /logout/i });
     await userEvent.click(logoutButton);
     
     expect(mockLogout).toHaveBeenCalled();
   });
   ```

2. **Logout Function Tests:**
   ```typescript
   import { renderHook, act, waitFor } from '@testing-library/react';
   import { AuthProvider, useAuth } from '@/components/auth/AuthProvider';
   
   test('logout clears user and redirects', async () => {
     const mockPush = vi.fn();
     vi.mock('next/navigation', () => ({
       useRouter: () => ({ push: mockPush }),
     }));
     
     const { result } = renderHook(() => useAuth(), {
       wrapper: AuthProvider,
     });
     
     // Set initial user
     act(() => {
       result.current.login({
         id: '123',
         username: '\\COLLEGE\\jdoe',
         is_blocked: false,
       });
     });
     
     expect(result.current.isAuthenticated).toBe(true);
     
     // Logout
     await act(async () => {
       await result.current.logout();
     });
     
     expect(result.current.isAuthenticated).toBe(false);
     expect(result.current.user).toBeNull();
     expect(mockPush).toHaveBeenCalledWith('/?logout=true');
   });
   ```

3. **Logout Message Tests:**
   ```typescript
   import { render, screen, waitFor } from '@testing-library/react';
   import LoginPage from '@/app/page';
   
   test('shows logout message when logout param present', async () => {
     // Mock useSearchParams to return logout=true
     vi.mock('next/navigation', () => ({
       useSearchParams: () => new URLSearchParams('logout=true'),
     }));
     
     render(<LoginPage />);
     
     await waitFor(() => {
       expect(screen.getByText(/logged out/i)).toBeInTheDocument();
       expect(screen.getByText(/you have been logged out/i)).toBeInTheDocument();
     });
   });
   
   test('does not show message on normal login page load', () => {
     vi.mock('next/navigation', () => ({
       useSearchParams: () => new URLSearchParams(''),
     }));
     
     render(<LoginPage />);
     
     expect(screen.queryByText(/logged out/i)).not.toBeInTheDocument();
   });
   ```

4. **API Authentication Tests:**
   ```typescript
   test('categories endpoint returns 401 after logout', async () => {
     // Login first
     const loginResponse = await fetch('/api/v1/auth/login', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       credentials: 'include',
       body: JSON.stringify({
         username: '\\COLLEGE\\testuser',
         password: 'testpassword',
       }),
     });
     expect(loginResponse.ok).toBe(true);
     
     // Verify can access categories
     let categoriesResponse = await fetch('/api/v1/counselors/categories', {
       credentials: 'include',
     });
     expect(categoriesResponse.status).toBe(200);
     
     // Logout
     const logoutResponse = await fetch('/api/v1/auth/logout', {
       method: 'POST',
       credentials: 'include',
     });
     expect(logoutResponse.ok).toBe(true);
     
     // Try to access categories again
     categoriesResponse = await fetch('/api/v1/counselors/categories', {
       credentials: 'include',
     });
     expect(categoriesResponse.status).toBe(401);
   });
   ```

5. **Keyboard Accessibility Tests:**
   ```typescript
   test('logout button is keyboard accessible', async () => {
     render(<DashboardHeader />);
     
     const logoutButton = screen.getByRole('button', { name: /logout/i });
     
     // Tab to button
     logoutButton.focus();
     expect(logoutButton).toHaveFocus();
     
     // Press Enter
     await userEvent.keyboard('{Enter}');
     expect(mockLogout).toHaveBeenCalled();
   });
   
   test('logout button triggers on Space key', async () => {
     render(<DashboardHeader />);
     
     const logoutButton = screen.getByRole('button', { name: /logout/i });
     
     logoutButton.focus();
     await userEvent.keyboard(' '); // Space key
     
     expect(mockLogout).toHaveBeenCalled();
   });
   ```

6. **Integration Tests:**
   ```typescript
   test('full logout flow works end-to-end', async () => {
     // Render app with authenticated user
     render(<App />);
     
     // User should be on dashboard
     await waitFor(() => {
       expect(screen.getByText(/welcome/i)).toBeInTheDocument();
     });
     
     // Click logout
     const logoutButton = screen.getByRole('button', { name: /logout/i });
     await userEvent.click(logoutButton);
     
     // Should redirect to login page
     await waitFor(() => {
       expect(screen.getByRole('button', { name: /login/i })).toBeInTheDocument();
     });
     
     // Should show logout message
     expect(screen.getByText(/you have been logged out/i)).toBeInTheDocument();
     
     // Try to navigate back to dashboard
     window.history.pushState({}, '', '/dashboard');
     
     // Should redirect back to login
     await waitFor(() => {
       expect(screen.getByRole('button', { name: /login/i })).toBeInTheDocument();
     });
   });
   ```

7. **E2E Test (Playwright - Optional):**
   ```typescript
   // e2e/logout.spec.ts
   import { test, expect } from '@playwright/test';
   
   test('user can logout from dashboard', async ({ page }) => {
     // Login
     await page.goto('/');
     await page.fill('input[name="username"]', '\\COLLEGE\\testuser');
     await page.fill('input[name="password"]', 'testpassword');
     await page.click('button[type="submit"]');
     
     // Should be on dashboard
     await expect(page).toHaveURL('/dashboard');
     await expect(page.locator('text=Welcome')).toBeVisible();
     
     // Click logout
     await page.click('button:has-text("Logout")');
     
     // Should be back on login page
     await expect(page).toHaveURL('/');
     await expect(page.locator('text=You have been logged out')).toBeVisible();
     
     // Try to navigate to dashboard directly
     await page.goto('/dashboard');
     
     // Should be redirected back to login
     await expect(page).toHaveURL('/');
   });
   ```

8. **Manual Testing Checklist:**
   - [ ] Logout button is visible in dashboard header
   - [ ] Clicking logout button logs user out
   - [ ] User redirected to login page after logout
   - [ ] Toast message "You have been logged out." appears
   - [ ] Message automatically dismisses after 3 seconds
   - [ ] Cannot access dashboard after logout (redirects to login)
   - [ ] Categories API returns 401 after logout
   - [ ] Any authenticated API returns 401 after logout
   - [ ] Can log in again after logging out
   - [ ] Logout button accessible via Tab key
   - [ ] Enter key triggers logout
   - [ ] Space key triggers logout
   - [ ] Focus indicator visible on logout button
   - [ ] Multiple logout clicks don't cause errors
   - [ ] Logout works from different pages (if applicable)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |