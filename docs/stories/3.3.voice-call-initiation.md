# Story 3.3: Frontend Voice Call Initiation

**Epic:** Epic 3 - Voice Calling Integration  
**Status:** Ready for Review  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student user,  
**I want** to click the voice call button on a counselor card and join a voice session,  
**so that** I can speak with an AI counselor in real-time.

---

## Acceptance Criteria

1. Voice call button on CounselorCard has onClick handler that calls handleVoiceCall function.
2. handleVoiceCall makes POST request to /api/voice/create-room with counselor category ID.
3. Button shows loading state (spinner, disabled) while room is being created.
4. On successful API response, user is navigated to /voice-session route with room credentials (room_url, user_token, session_id) passed as state or query params.
5. Error handling: if API fails, show error toast with retry option.
6. Loading state prevents multiple simultaneous room creation requests.
7. User cannot initiate voice call if not authenticated (checked by AuthContext).
8. Voice button displays microphone icon from Lucide React.
9. Unit tests mock API call and verify navigation on success.

---

## Tasks / Subtasks

- [x] Update handleVoiceCall in CounselorCard component (AC: 1, 2, 3)
  - [x] Remove placeholder toast notification
  - [x] Add loading state (isVoiceLoading)
  - [x] Make POST request to /api/voice/create-room
  - [x] Pass counselor category UUID in request body
  - [x] Handle response data (room_url, user_token, session_id)
  - [x] Add error handling with try-catch
  
- [x] Implement navigation to voice session page (AC: 4)
  - [x] Use Next.js router to navigate to /voice-session
  - [x] Pass room credentials via router state or query params
  - [x] Ensure credentials are not exposed in browser history
  
- [x] Add error handling and user feedback (AC: 5)
  - [x] Show error toast on API failure
  - [x] Include retry button in error message
  - [x] Log error details to console for debugging
  - [x] Clear loading state on error
  
- [x] Prevent duplicate requests (AC: 6)
  - [x] Disable button while isVoiceLoading is true
  - [x] Add guard clause to prevent multiple simultaneous calls
  - [x] Show visual feedback (spinner icon replaces microphone)
  
- [x] Verify authentication requirement (AC: 7)
  - [x] Check useAuth hook for current user
  - [x] Redirect to login if not authenticated
  - [x] Show error message if session expired
  
- [x] Ensure voice button styling matches design (AC: 8)
  - [x] Use Mic icon from lucide-react
  - [x] Button should be primary (filled) variant
  - [x] Spinner icon during loading state
  - [x] Maintain accessibility (aria-label, keyboard support)
  
- [x] Write comprehensive tests (AC: 9)
  - [x] Mock /api/voice/create-room API call
  - [x] Test successful room creation and navigation
  - [x] Test error scenarios (API failure, network error)
  - [x] Test loading state behavior
  - [x] Test authentication requirement
  - [x] Test duplicate request prevention

---

## Dev Notes

### Architecture Overview (From Architecture Document)

**Voice Session Flow:**
1. User clicks voice button on counselor card
2. Frontend calls POST /api/voice/create-room
3. Backend creates Daily.co room and spawns PipeCat bot
4. Frontend receives room credentials
5. User navigated to /voice-session page
6. Voice session page initializes Daily client (Story 3.4)

**Security Considerations:**
- Room tokens are short-lived (24 hours)
- Tokens tied to authenticated user
- Room URLs should not be shareable (single-use)

### Updated CounselorCard Component

**app/components/CounselorCard.tsx:**
```typescript
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Mic, Video, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { useToast } from '@/components/ui/use-toast';
import { useAuth } from '@/contexts/AuthContext';
import { CounselorCategory } from '@/types';

interface CounselorCardProps {
  counselor: CounselorCategory;
}

export function CounselorCard({ counselor }: CounselorCardProps) {
  const [isVoiceLoading, setIsVoiceLoading] = useState(false);
  const [isVideoLoading, setIsVideoLoading] = useState(false);
  const router = useRouter();
  const { toast } = useToast();
  const { user } = useAuth();

  const handleVoiceCall = async () => {
    // Guard: prevent duplicate requests
    if (isVoiceLoading) return;

    // Guard: check authentication
    if (!user) {
      toast({
        title: "Authentication Required",
        description: "Please log in to start a voice session.",
        variant: "destructive"
      });
      router.push('/login');
      return;
    }

    setIsVoiceLoading(true);

    try {
      const response = await fetch('/api/v1/voice/create-room', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Include auth cookie
        body: JSON.stringify({
          counselor_category: counselor.id
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to create voice session');
      }

      const data = await response.json();
      
      // Navigate to voice session page with room credentials
      router.push(
        `/voice-session?` +
        `room_url=${encodeURIComponent(data.room_url)}&` +
        `user_token=${encodeURIComponent(data.user_token)}&` +
        `session_id=${encodeURIComponent(data.session_id)}&` +
        `category=${encodeURIComponent(counselor.name)}`
      );

    } catch (error) {
      console.error('Voice call initiation error:', error);
      
      toast({
        title: "Connection Failed",
        description: error instanceof Error ? error.message : "Unable to start voice session. Please try again.",
        variant: "destructive",
        action: (
          <Button 
            variant="outline" 
            size="sm" 
            onClick={() => handleVoiceCall()}
          >
            Retry
          </Button>
        )
      });
    } finally {
      setIsVoiceLoading(false);
    }
  };

  const handleVideoCall = async () => {
    // Placeholder for Story 4.x (Video Calling)
    setIsVideoLoading(true);
    setTimeout(() => {
      toast({
        title: "Coming Soon",
        description: "Video calling will be available soon!"
      });
      setIsVideoLoading(false);
    }, 1000);
  };

  return (
    <Card className="hover:shadow-lg transition-shadow">
      <CardHeader>
        <div className="flex items-center gap-3">
          <div className="text-4xl">{counselor.icon}</div>
          <div>
            <CardTitle>{counselor.name}</CardTitle>
            <CardDescription>{counselor.description}</CardDescription>
          </div>
        </div>
      </CardHeader>
      <CardFooter className="flex gap-2">
        <Button
          onClick={handleVoiceCall}
          disabled={isVoiceLoading}
          className="flex-1"
          aria-label={`Start voice call with ${counselor.name}`}
        >
          {isVoiceLoading ? (
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          ) : (
            <Mic className="mr-2 h-4 w-4" />
          )}
          {isVoiceLoading ? 'Connecting...' : 'Voice Call'}
        </Button>
        
        <Button
          variant="outline"
          onClick={handleVideoCall}
          disabled={isVideoLoading}
          className="flex-1"
          aria-label={`Start video call with ${counselor.name}`}
        >
          {isVideoLoading ? (
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
          ) : (
            <Video className="mr-2 h-4 w-4" />
          )}
          {isVideoLoading ? 'Connecting...' : 'Video Call'}
        </Button>
      </CardFooter>
    </Card>
  );
}
```

### API Client Utility (Optional)

**lib/api/voice.ts:**
```typescript
import { UUID } from 'crypto';

export interface CreateRoomRequest {
  counselor_category: string; // UUID
}

export interface CreateRoomResponse {
  room_url: string;
  user_token: string;
  room_name: string;
  session_id: string;
}

export async function createVoiceRoom(
  categoryId: string
): Promise<CreateRoomResponse> {
  const response = await fetch('/api/v1/voice/create-room', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({
      counselor_category: categoryId
    })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || 'Failed to create voice room');
  }

  return response.json();
}

// Alternative implementation using this utility:
// const data = await createVoiceRoom(counselor.id);
// router.push(`/voice-session?room_url=...`);
```

### Voice Session Route Setup

**app/voice-session/page.tsx (placeholder for Story 3.4):**
```typescript
'use client';

import { useSearchParams } from 'next/navigation';
import { Suspense } from 'react';

function VoiceSessionContent() {
  const searchParams = useSearchParams();
  
  const roomUrl = searchParams.get('room_url');
  const userToken = searchParams.get('user_token');
  const sessionId = searchParams.get('session_id');
  const category = searchParams.get('category');

  if (!roomUrl || !userToken || !sessionId) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <p className="text-destructive">Invalid session parameters</p>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-4">
      <h1>Voice Session: {category}</h1>
      <p>Room URL: {roomUrl}</p>
      <p>Session ID: {sessionId}</p>
      {/* Story 3.4 will implement RTVIClient connection here */}
    </div>
  );
}

export default function VoiceSessionPage() {
  return (
    <Suspense fallback={<div>Loading session...</div>}>
      <VoiceSessionContent />
    </Suspense>
  );
}
```

### Error Handling Patterns

**Common errors and handling:**

1. **Authentication Failure (401):**
   ```typescript
   if (response.status === 401) {
     toast({ title: "Session Expired", description: "Please log in again." });
     router.push('/login');
     return;
   }
   ```

2. **Category Not Found (404):**
   ```typescript
   if (response.status === 404) {
     toast({ title: "Counselor Unavailable", description: "This counselor category is currently unavailable." });
     return;
   }
   ```

3. **Server Error (500):**
   ```typescript
   if (response.status === 500) {
     toast({ 
       title: "Server Error", 
       description: "Unable to connect. Our team has been notified.",
       action: <Button onClick={handleVoiceCall}>Retry</Button>
     });
     return;
   }
   ```

4. **Network Error:**
   ```typescript
   catch (error) {
     if (error instanceof TypeError && error.message.includes('fetch')) {
       toast({ title: "Network Error", description: "Please check your internet connection." });
     }
   }
   ```

### Source Tree Updates

```
packages/frontend/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ voice-session/
â”‚       â””â”€â”€ page.tsx              # Voice session page (Story 3.4)
â”œâ”€â”€ components/
â”‚   â””â”€â”€ CounselorCard.tsx         # Updated with voice call logic
â””â”€â”€ lib/
    â””â”€â”€ api/
        â””â”€â”€ voice.ts              # (Optional) Voice API utilities
```

---

## Testing

### Testing Standards

**Test Locations:**
- Component tests: `__tests__/components/CounselorCard.test.tsx`
- API utility tests: `__tests__/lib/api/voice.test.ts`
- Integration tests: `e2e/voice-initiation.spec.ts`

**Testing Framework:**
- Vitest 1.2.0 with React Testing Library
- MSW (Mock Service Worker) for API mocking
- Playwright for E2E tests

**Testing Requirements:**

1. **Voice Call Initiation Test:**
   ```typescript
   import { render, screen, fireEvent, waitFor } from '@testing-library/react';
   import { vi } from 'vitest';
   import { CounselorCard } from '@/components/CounselorCard';
   import { AuthProvider } from '@/contexts/AuthContext';
   import { useRouter } from 'next/navigation';

   vi.mock('next/navigation');

   describe('CounselorCard Voice Call', () => {
     const mockCounselor = {
       id: '123e4567-e89b-12d3-a456-426614174000',
       name: 'Health Counselor',
       description: 'Mental health support',
       icon: 'ðŸ¥',
       enabled: true
     };

     const mockPush = vi.fn();
     const mockUser = { user_id: 'user-123', username: 'testuser' };

     beforeEach(() => {
       vi.mocked(useRouter).mockReturnValue({ push: mockPush } as any);
       global.fetch = vi.fn();
     });

     it('calls API and navigates on successful voice call', async () => {
       const mockResponse = {
         room_url: 'https://test.daily.co/room',
         user_token: 'token-123',
         session_id: 'session-456',
       };

       (global.fetch as any).mockResolvedValueOnce({
         ok: true,
         json: async () => mockResponse
       });

       render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const voiceButton = screen.getByLabelText(/start voice call/i);
       fireEvent.click(voiceButton);

       await waitFor(() => {
         expect(global.fetch).toHaveBeenCalledWith(
           '/api/v1/voice/create-room',
           expect.objectContaining({
             method: 'POST',
             body: JSON.stringify({ counselor_category: mockCounselor.id })
           })
         );
       });

       await waitFor(() => {
         expect(mockPush).toHaveBeenCalledWith(
           expect.stringContaining('/voice-session')
         );
       });
     });

     it('shows loading state during API call', async () => {
       (global.fetch as any).mockImplementation(() => new Promise(() => {}));

       render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const voiceButton = screen.getByLabelText(/start voice call/i);
       fireEvent.click(voiceButton);

       await waitFor(() => {
         expect(screen.getByText(/connecting/i)).toBeInTheDocument();
         expect(voiceButton).toBeDisabled();
       });
     });

     it('shows error toast on API failure', async () => {
       (global.fetch as any).mockResolvedValueOnce({
         ok: false,
         json: async () => ({ detail: 'Room creation failed' })
       });

       const { container } = render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const voiceButton = screen.getByLabelText(/start voice call/i);
       fireEvent.click(voiceButton);

       await waitFor(() => {
         expect(screen.getByText(/connection failed/i)).toBeInTheDocument();
       });
     });

     it('redirects to login if not authenticated', async () => {
       render(
         <AuthProvider value={{ user: null }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const voiceButton = screen.getByLabelText(/start voice call/i);
       fireEvent.click(voiceButton);

       await waitFor(() => {
         expect(mockPush).toHaveBeenCalledWith('/login');
       });
     });

     it('prevents duplicate simultaneous calls', async () => {
       (global.fetch as any).mockImplementation(() => new Promise(() => {}));

       render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const voiceButton = screen.getByLabelText(/start voice call/i);
       
       fireEvent.click(voiceButton);
       fireEvent.click(voiceButton);
       fireEvent.click(voiceButton);

       await waitFor(() => {
         expect(global.fetch).toHaveBeenCalledTimes(1);
       });
     });
   });
   ```

2. **E2E Voice Initiation Test:**
   ```typescript
   import { test, expect } from '@playwright/test';

   test.describe('Voice Call Initiation', () => {
     test.beforeEach(async ({ page }) => {
       // Login
       await page.goto('/login');
       await page.fill('input[name="username"]', 'testuser');
       await page.fill('input[name="password"]', 'testpass');
       await page.click('button[type="submit"]');
       
       // Wait for dashboard
       await page.waitForURL('/dashboard');
     });

     test('starts voice call from counselor card', async ({ page }) => {
       // Find Health Counselor card
       const healthCard = page.locator('text=Health Counselor').locator('..');
       
       // Click voice button
       await healthCard.locator('button:has-text("Voice Call")').click();
       
       // Should show loading state
       await expect(healthCard.locator('text=Connecting')).toBeVisible();
       
       // Should navigate to voice session
       await page.waitForURL(/\/voice-session\?/);
       
       // Verify URL contains required params
       const url = page.url();
       expect(url).toContain('room_url=');
       expect(url).toContain('user_token=');
       expect(url).toContain('session_id=');
     });

     test('shows error on failed room creation', async ({ page, context }) => {
       // Mock API to return error
       await context.route('**/api/v1/voice/create-room', route => {
         route.fulfill({
           status: 500,
           body: JSON.stringify({ detail: 'Server error' })
         });
       });

       const healthCard = page.locator('text=Health Counselor').locator('..');
       await healthCard.locator('button:has-text("Voice Call")').click();

       // Should show error toast
       await expect(page.locator('text=Connection Failed')).toBeVisible();
       await expect(page.locator('text=Retry')).toBeVisible();
     });
   });
   ```

3. **Manual Testing Checklist:**
   - [ ] Voice button click initiates API call
   - [ ] Loading spinner shown during API call
   - [ ] Button disabled during loading
   - [ ] Successful API response navigates to /voice-session
   - [ ] Room credentials passed in URL params
   - [ ] Error toast shown on API failure
   - [ ] Retry button in error toast works
   - [ ] Unauthenticated users redirected to login
   - [ ] Cannot click voice button multiple times
   - [ ] Error logged to console for debugging
   - [ ] Network error shows appropriate message
   - [ ] 401 error clears auth state and redirects

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### File List
- packages/frontend/components/dashboard/CounselorCardGrid.tsx (Modified)
- packages/frontend/app/voice-session/page.tsx (Created)
- packages/frontend/lib/api.ts (Modified)
- packages/frontend/__tests__/components/dashboard/CounselorCardGrid.voice.test.tsx (Created)
- packages/frontend/__tests__/lib/api.voice.test.ts (Created)
- packages/frontend/__tests__/app/voice-session/page.test.tsx (Created)
- packages/frontend/__tests__/components/dashboard/CounselorCardGrid.test.tsx (Modified - added mocks for useAuth and useRouter)

### Completion Notes
- Implemented full voice call initiation flow in CounselorCardGrid component
- Added authentication checks and redirects for unauthenticated users
- Implemented loading states and error handling with retry functionality
- Created voice session page placeholder for Story 3.4
- Added API utility functions for voice room creation
- Created comprehensive test suites covering all acceptance criteria
- All new tests pass successfully (19 tests)
- Note: Existing CounselorCardGrid tests needed auth mocking updates due to new useAuth dependency

### Debug Log

None - Implementation completed successfully

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-21 | 2.0 | Story implementation completed | James (Dev) |
