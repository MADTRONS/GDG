# Story 3.6: In-Session Controls

**Epic:** Epic 3 - Voice Calling Integration  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student user,  
**I want** to control my audio settings during a voice session,  
**so that** I can mute myself, adjust volume, or end the call when ready.

---

## Acceptance Criteria

1. Voice session view displays control panel with buttons: Mute Microphone, End Session, and Volume Slider.
2. Mute button toggles microphone mute state using RTVIClient API; button shows muted status visually (icon change from Mic to MicOff, color change to red).
3. Volume slider adjusts output volume for counselor's voice (range: 0-100%).
4. End Session button prompts confirmation dialog: "Are you sure you want to end this session?"
5. On confirm end session, RTVIClient disconnects from Daily.co room, session data prepared for saving (Story 3.7), user redirected to dashboard.
6. All controls are keyboard accessible (Tab navigation, Enter/Space activation) and screen reader friendly.
7. Connection quality indicator displayed (green=excellent, yellow=fair, red=poor) based on network stats from Daily.co.
8. Controls disabled when not connected to session.
9. Unit tests verify control interactions.

---

## Tasks / Subtasks

- [ ] Implement Mute button functionality (AC: 2, 8)
  - [ ] Add isMuted state (already exists from Story 3.4)
  - [ ] Implement toggleMute function with RTVIClient API
  - [ ] Update button icon (Mic ↔ MicOff)
  - [ ] Change button color when muted (red variant)
  - [ ] Disable button when not connected
  - [ ] Add keyboard support (Enter/Space)
  
- [ ] Implement Volume slider (AC: 3)
  - [ ] Add volume state (0-100)
  - [ ] Create Slider component using shadcn/ui
  - [ ] Connect slider to Daily.co output volume API
  - [ ] Show volume percentage label
  - [ ] Persist volume preference in localStorage
  - [ ] Add keyboard support (arrow keys)
  
- [ ] Enhance End Session button (AC: 4, 5)
  - [ ] Already implemented in Story 3.4, ensure confirmation dialog works
  - [ ] Prepare session data for saving before disconnect
  - [ ] Call session save API (Story 3.7)
  - [ ] Show loading state during disconnect
  - [ ] Navigate to dashboard on completion
  
- [ ] Implement Connection Quality indicator (AC: 7)
  - [ ] Listen to Daily.co network quality events
  - [ ] Create ConnectionQuality component
  - [ ] Display indicator with color and text (Excellent/Fair/Poor)
  - [ ] Update indicator in real-time
  - [ ] Add tooltip explaining quality levels
  
- [ ] Ensure keyboard accessibility (AC: 6)
  - [ ] All buttons tabbable
  - [ ] All buttons activatable with Enter/Space
  - [ ] Volume slider adjustable with arrow keys
  - [ ] Focus visible on all interactive elements
  - [ ] Test with keyboard-only navigation
  
- [ ] Ensure screen reader accessibility (AC: 6)
  - [ ] Add aria-label to all buttons
  - [ ] Announce mute state changes
  - [ ] Announce volume changes
  - [ ] Announce connection quality changes
  - [ ] Test with NVDA/JAWS screen readers
  
- [ ] Disable controls when disconnected (AC: 8)
  - [ ] Check connectionState before enabling controls
  - [ ] Gray out disabled buttons
  - [ ] Show tooltip explaining why disabled
  
- [ ] Write comprehensive tests (AC: 9)
  - [ ] Test mute toggle functionality
  - [ ] Test volume slider changes
  - [ ] Test end session flow
  - [ ] Test connection quality updates
  - [ ] Test keyboard navigation
  - [ ] Test screen reader announcements

---

## Dev Notes

### Architecture Overview (From Architecture Document)

**Control Requirements:**
- Mute: Uses RTVIClient.enableMic() / disableMic()
- Volume: Uses Daily.co setOutputVolume() API
- Connection Quality: Daily.co provides network-stats event with quality metrics
- Session End: Disconnect RTVIClient, save transcript, navigate away

**User Experience Considerations:**
- Controls should be always visible and easy to reach
- Mute button most frequently used, make it prominent
- Volume adjustment less common, can be secondary control
- End Session critical action, requires confirmation

### Enhanced SessionControls Component

**components/voice/SessionControls.tsx:**
```typescript
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Slider } from '@/components/ui/slider';
import { Card } from '@/components/ui/card';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { Mic, MicOff, PhoneOff, Volume2 } from 'lucide-react';
import { ConnectionState } from '@/types/voice';

interface SessionControlsProps {
  isMuted: boolean;
  onToggleMute: () => void;
  volume: number;
  onVolumeChange: (volume: number) => void;
  onEndSession: () => void;
  connectionState: ConnectionState;
  connectionQuality: 'excellent' | 'fair' | 'poor' | null;
}

export function SessionControls({
  isMuted,
  onToggleMute,
  volume,
  onVolumeChange,
  onEndSession,
  connectionState,
  connectionQuality
}: SessionControlsProps) {
  const isConnected = connectionState === 'connected';

  const qualityConfig = {
    excellent: { color: 'text-green-600', label: 'Excellent', bgColor: 'bg-green-600' },
    fair: { color: 'text-yellow-600', label: 'Fair', bgColor: 'bg-yellow-600' },
    poor: { color: 'text-red-600', label: 'Poor', bgColor: 'bg-red-600' }
  };

  const currentQuality = connectionQuality ? qualityConfig[connectionQuality] : null;

  return (
    <Card className="p-4">
      <div className="space-y-4">
        {/* Connection Quality Indicator */}
        {currentQuality && (
          <div className="flex items-center justify-between pb-3 border-b">
            <span className="text-sm font-medium">Connection Quality:</span>
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <div className="flex items-center gap-2">
                    <div className={`h-3 w-3 rounded-full ${currentQuality.bgColor}`} />
                    <span className={`text-sm ${currentQuality.color}`}>
                      {currentQuality.label}
                    </span>
                  </div>
                </TooltipTrigger>
                <TooltipContent>
                  <p>Network connection quality affects call clarity</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          </div>
        )}

        {/* Main Controls */}
        <div className="flex gap-3">
          {/* Mute Button */}
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  onClick={onToggleMute}
                  disabled={!isConnected}
                  variant={isMuted ? 'destructive' : 'secondary'}
                  className="flex-1"
                  aria-label={isMuted ? 'Unmute microphone' : 'Mute microphone'}
                  aria-pressed={isMuted}
                >
                  {isMuted ? (
                    <MicOff className="mr-2 h-4 w-4" />
                  ) : (
                    <Mic className="mr-2 h-4 w-4" />
                  )}
                  {isMuted ? 'Unmute' : 'Mute'}
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>{isMuted ? 'Turn microphone on' : 'Turn microphone off'}</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>

          {/* End Session Button */}
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <Button
                  onClick={onEndSession}
                  variant="destructive"
                  className="flex-1"
                  aria-label="End session"
                >
                  <PhoneOff className="mr-2 h-4 w-4" />
                  End Session
                </Button>
              </TooltipTrigger>
              <TooltipContent>
                <p>Disconnect and return to dashboard</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        </div>

        {/* Volume Control */}
        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <label htmlFor="volume-slider" className="text-sm font-medium flex items-center gap-2">
              <Volume2 className="h-4 w-4" />
              Volume
            </label>
            <span className="text-sm text-muted-foreground" aria-live="polite">
              {volume}%
            </span>
          </div>
          <Slider
            id="volume-slider"
            value={[volume]}
            onValueChange={([value]) => onVolumeChange(value)}
            min={0}
            max={100}
            step={5}
            disabled={!isConnected}
            aria-label="Adjust counselor volume"
            className="w-full"
          />
        </div>
      </div>
    </Card>
  );
}
```

### Updated Voice Session Page (with Controls)

**app/voice-session/page.tsx (additions):**
```typescript
function VoiceSessionContent() {
  // ... existing state ...
  const [volume, setVolume] = useState(80); // Default 80%
  const [connectionQuality, setConnectionQuality] = useState<'excellent' | 'fair' | 'poor' | null>(null);

  // Load saved volume preference
  useEffect(() => {
    const savedVolume = localStorage.getItem('voice-session-volume');
    if (savedVolume) {
      setVolume(parseInt(savedVolume, 10));
    }
  }, []);

  // Initialize RTVI Client
  useEffect(() => {
    // ... existing client setup ...

    // NEW: Listen to Daily.co network quality events
    const dailyCall = rtviClientRef.current?.transport?.daily;
    if (dailyCall) {
      dailyCall.on('network-quality-change', (event: any) => {
        const { quality } = event;
        
        // Map Daily.co quality threshold to our categories
        if (quality > 0.7) {
          setConnectionQuality('excellent');
        } else if (quality > 0.4) {
          setConnectionQuality('fair');
        } else {
          setConnectionQuality('poor');
        }
      });
    }
  }, [/* ... */]);

  // Volume change handler
  const handleVolumeChange = async (newVolume: number) => {
    setVolume(newVolume);
    localStorage.setItem('voice-session-volume', newVolume.toString());

    // Apply volume to Daily.co output
    const dailyCall = rtviClientRef.current?.transport?.daily;
    if (dailyCall) {
      try {
        await dailyCall.setOutputVolume(newVolume / 100); // Daily expects 0.0-1.0
      } catch (error) {
        console.error('Failed to set volume:', error);
      }
    }
  };

  // Enhanced end session handler (prepare for Story 3.7)
  const handleEndSession = async () => {
    // Prepare session data for saving
    const sessionData = {
      session_id: sessionId,
      transcript,
      duration: Math.floor((Date.now() - sessionStartTime) / 1000), // seconds
      ended_at: new Date().toISOString()
    };

    // Disconnect client
    if (rtviClientRef.current) {
      await rtviClientRef.current.disconnect();
    }

    // Save session (Story 3.7 will implement full API call)
    console.log('Session data to save:', sessionData);

    toast({
      title: "Session Ended",
      description: "Your counseling session has ended. Take care!"
    });

    router.push('/dashboard');
  };

  // ... existing render ...

  return (
    <div className="container mx-auto min-h-screen p-4">
      <div className="grid md:grid-cols-[1fr,400px] gap-4 h-[calc(100vh-2rem)]">
        {/* Main session area */}
        <div className="flex flex-col gap-4">
          <Card className="flex-1">
            {/* Session content (microphone visualization, etc.) */}
          </Card>

          {/* Session Controls */}
          <SessionControls
            isMuted={isMuted}
            onToggleMute={toggleMute}
            volume={volume}
            onVolumeChange={handleVolumeChange}
            onEndSession={() => setShowEndDialog(true)}
            connectionState={connectionState}
            connectionQuality={connectionQuality}
          />
        </div>

        {/* Transcript panel */}
        <TranscriptPanel entries={transcript} />
      </div>

      {/* End session confirmation dialog (already exists) */}
    </div>
  );
}
```

### Keyboard Accessibility Implementation

Ensure all controls work with keyboard:

```typescript
// Button accessibility is automatic with shadcn/ui Button component
// Slider needs additional keyboard support

<Slider
  onKeyDown={(e) => {
    // Custom arrow key handling if needed
    if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
      e.preventDefault();
      onVolumeChange(Math.min(100, volume + 5));
    } else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
      e.preventDefault();
      onVolumeChange(Math.max(0, volume - 5));
    }
  }}
/>
```

### Source Tree Updates

```
packages/frontend/
├── app/
│   └── voice-session/
│       └── page.tsx              # Updated with volume and quality controls
└── components/
    ├── voice/
    │   └── SessionControls.tsx   # New component for session controls
    └── ui/
        ├── slider.tsx            # shadcn/ui Slider component
        └── tooltip.tsx           # shadcn/ui Tooltip component
```

---

## Testing

### Testing Requirements:

1. **Mute Toggle Test:**
   ```typescript
   it('toggles mute state and updates UI', async () => {
     const mockClient = {
       enableMic: vi.fn(),
       disableMic: vi.fn()
     };

     render(<VoiceSessionPage />);

     const muteButton = screen.getByLabelText('Mute microphone');
     
     // Mute
     fireEvent.click(muteButton);
     await waitFor(() => {
       expect(mockClient.disableMic).toHaveBeenCalled();
       expect(screen.getByLabelText('Unmute microphone')).toBeInTheDocument();
     });

     // Unmute
     const unmuteButton = screen.getByLabelText('Unmute microphone');
     fireEvent.click(unmuteButton);
     await waitFor(() => {
       expect(mockClient.enableMic).toHaveBeenCalled();
     });
   });
   ```

2. **Volume Control Test:**
   ```typescript
   it('adjusts volume and persists to localStorage', async () => {
     render(<SessionControls {...defaultProps} />);

     const volumeSlider = screen.getByLabelText('Adjust counselor volume');
     
     fireEvent.change(volumeSlider, { target: { value: 60 } });

     await waitFor(() => {
       expect(screen.getByText('60%')).toBeInTheDocument();
       expect(localStorage.getItem('voice-session-volume')).toBe('60');
     });
   });
   ```

3. **Connection Quality Test:**
   ```typescript
   it('displays connection quality indicator', () => {
     render(
       <SessionControls 
         {...defaultProps} 
         connectionQuality="excellent"
       />
     );

     expect(screen.getByText('Excellent')).toBeInTheDocument();
     expect(screen.getByText('Excellent').previousSibling).toHaveClass('bg-green-600');
   });
   ```

4. **Keyboard Accessibility Test:**
   ```typescript
   it('controls are keyboard accessible', () => {
     render(<SessionControls {...defaultProps} />);

     const muteButton = screen.getByLabelText('Mute microphone');
     
     muteButton.focus();
     expect(muteButton).toHaveFocus();

     // Tab to next control
     userEvent.tab();
     expect(screen.getByLabelText('End session')).toHaveFocus();
   });
   ```

5. **Manual Testing Checklist:**
   - [ ] Mute button toggles microphone on/off
   - [ ] Mute button icon changes (Mic ↔ MicOff)
   - [ ] Mute button color changes when muted (red)
   - [ ] Volume slider adjusts bot voice volume
   - [ ] Volume percentage displayed and updates
   - [ ] Volume preference saved to localStorage
   - [ ] End session button shows confirmation dialog
   - [ ] End session disconnects and navigates to dashboard
   - [ ] Connection quality indicator shows correct color
   - [ ] Quality updates in real-time during connection changes
   - [ ] All buttons disabled when not connected
   - [ ] Tab key navigates through all controls
   - [ ] Enter/Space activates buttons
   - [ ] Arrow keys adjust volume slider
   - [ ] Screen reader announces control states
   - [ ] Tooltips provide helpful context

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
