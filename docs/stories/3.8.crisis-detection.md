# Story 3.8: Crisis Detection and Safety Features

**Epic:** Epic 3 - Voice Calling Integration  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** system,  
**I want** to detect crisis keywords in conversations and provide immediate access to emergency resources,  
**so that** students in distress receive help quickly.

---

## Acceptance Criteria

1. PipeCat bot system prompt includes instruction: "If user expresses suicidal thoughts, self-harm ideation, or immediate danger, respond with empathy and provide crisis hotline: National Suicide Prevention Lifeline 988."
2. Frontend transcript panel monitors user messages for crisis keywords (suicide, kill myself, self-harm, end it all, want to die, etc.) in real-time.
3. If crisis keyword detected, frontend displays prominent alert banner at top of page with: red background, emergency hotline numbers (988, campus counseling center), "Connect to Crisis Line" button.
4. Alert banner remains visible until user dismisses it or session ends.
5. When crisis detected, frontend sets crisisDetected flag to true, which is saved to backend when session ends (Story 3.7).
6. Crisis detection logic is case-insensitive and handles variations (e.g., "sui cide", "k*ll myself").
7. False positives minimized by requiring full word matches and context (e.g., "I want to live" should NOT trigger).
8. Crisis detection tested with variety of keyword phrases and edge cases.
9. Unit tests verify keyword detection logic.

---

## Tasks / Subtasks

- [ ] Update PipeCat bot system prompts (AC: 1)
  - [ ] Add crisis response instruction to all 6 category prompts
  - [ ] Ensure bot directs user to 988 hotline
  - [ ] Include empathetic language
  - [ ] Test bot responses to crisis phrases
  - [ ] Update seed data script
  
- [ ] Create crisis keyword list (AC: 2, 6)
  - [ ] Define comprehensive keyword array
  - [ ] Include variations and misspellings
  - [ ] Research effective crisis keyword patterns
  - [ ] Consider context-aware keywords
  - [ ] Document rationale for each keyword
  
- [ ] Implement keyword detection function (AC: 2, 6, 7)
  - [ ] Create detectCrisisKeywords utility function
  - [ ] Normalize text (lowercase, remove special chars)
  - [ ] Use word boundary regex for full word matching
  - [ ] Handle common obfuscations (spaces, asterisks)
  - [ ] Return matched keywords for logging
  
- [ ] Create CrisisAlert component (AC: 3, 4)
  - [ ] Design prominent red banner
  - [ ] Display crisis hotline numbers clearly
  - [ ] Add "Call 988" and "Dismiss" buttons
  - [ ] Make banner sticky at top of viewport
  - [ ] Ensure high contrast for readability
  - [ ] Add accessibility attributes
  
- [ ] Integrate crisis detection in transcript monitoring (AC: 2, 5)
  - [ ] Monitor transcript updates in real-time
  - [ ] Check each new user message for keywords
  - [ ] Set crisisDetected state on match
  - [ ] Log detection event for debugging
  - [ ] Persist crisis flag for session save
  
- [ ] Implement "Connect to Crisis Line" button (AC: 3)
  - [ ] Link button to tel:988 (mobile)
  - [ ] Open 988lifeline.org in new tab (desktop)
  - [ ] Track click event for analytics
  - [ ] Show confirmation after click
  
- [ ] Handle alert dismissal (AC: 4)
  - [ ] Add dismiss button with confirmation
  - [ ] Keep crisis flag set even after dismissal
  - [ ] Allow alert to reappear if additional keywords detected
  - [ ] Log dismissal event
  
- [ ] Minimize false positives (AC: 7)
  - [ ] Test with ambiguous phrases
  - [ ] Refine keyword list based on testing
  - [ ] Consider sentiment analysis for future enhancement
  - [ ] Document known limitations
  
- [ ] Write comprehensive tests (AC: 8, 9)
  - [ ] Unit test keyword detection function
  - [ ] Test all keywords in list
  - [ ] Test variations and edge cases
  - [ ] Test false positive scenarios
  - [ ] Test alert display and dismissal
  - [ ] Integration test crisis flow

---

## Dev Notes

### Architecture Overview (From Architecture Document)

**Crisis Response Protocol:**
1. **Prevention:** Bot system prompt includes crisis response guidelines
2. **Detection:** Frontend monitors transcript for crisis keywords
3. **Intervention:** Immediate display of crisis resources
4. **Documentation:** Session flagged for administrative follow-up
5. **Limitation:** This is NOT clinical monitoring, just keyword-based alerting

**Ethical Considerations:**
- Students should be informed that sessions are monitored for safety (in Terms of Service)
- Crisis detection is a safety net, not a replacement for professional mental health services
- False positives are acceptable to avoid missing true crises

### Crisis Keyword List

**lib/crisis-keywords.ts:**
```typescript
export const CRISIS_KEYWORDS = [
  // Direct suicidal ideation
  'suicide',
  'suicidal',
  'kill myself',
  'killing myself',
  'end my life',
  'ending my life',
  'want to die',
  'wish I was dead',
  'wish I were dead',
  'better off dead',
  'take my own life',
  'end it all',
  'no reason to live',
  'can\'t go on',
  'nothing to live for',
  
  // Self-harm
  'self harm',
  'self-harm',
  'hurt myself',
  'hurting myself',
  'cut myself',
  'cutting myself',
  
  // Methods (sensitive but necessary)
  'overdose',
  'jump off',
  'hang myself',
  'hanging myself',
  
  // Variations/obfuscations
  'sui cide', // common obfuscation
  's*icide',
  'k*ll myself',
  'unalive', // internet slang for suicide
  
  // Crisis phrases
  'goodbye forever',
  'final goodbye',
  'this is the end',
  'can\'t take it anymore',
  'world is better without me',
  'everyone would be better off'
];

// Positive context phrases that should NOT trigger (for filtering false positives)
export const NEGATIVE_CONTEXT_PHRASES = [
  'don\'t want to die',
  'not suicidal',
  'won\'t kill myself',
  'never hurt myself',
  'choose to live',
  'want to live',
  'reasons to live'
];
```

### Crisis Detection Utility

**lib/detect-crisis.ts:**
```typescript
import { CRISIS_KEYWORDS, NEGATIVE_CONTEXT_PHRASES } from './crisis-keywords';

export interface CrisisDetectionResult {
  detected: boolean;
  matchedKeywords: string[];
  message: string;
}

/**
 * Detect crisis keywords in a message.
 * 
 * @param message - The message text to analyze
 * @returns CrisisDetectionResult with detection status and matched keywords
 */
export function detectCrisisKeywords(message: string): CrisisDetectionResult {
  const normalizedMessage = message.toLowerCase().trim();
  
  // First, check for negative context (phrases that indicate safety)
  const hasNegativeContext = NEGATIVE_CONTEXT_PHRASES.some(phrase => 
    normalizedMessage.includes(phrase)
  );
  
  if (hasNegativeContext) {
    return {
      detected: false,
      matchedKeywords: [],
      message
    };
  }
  
  // Check for crisis keywords with word boundaries
  const matchedKeywords: string[] = [];
  
  for (const keyword of CRISIS_KEYWORDS) {
    // Create regex with word boundaries for full-word matching
    // Handle multi-word phrases
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const pattern = new RegExp(`\\b${escapedKeyword}\\b`, 'i');
    
    if (pattern.test(normalizedMessage)) {
      matchedKeywords.push(keyword);
    }
  }
  
  return {
    detected: matchedKeywords.length > 0,
    matchedKeywords,
    message
  };
}

/**
 * Check multiple messages for crisis content.
 * Useful for analyzing entire conversation history.
 */
export function analyzeCrisisInTranscript(messages: string[]): boolean {
  return messages.some(msg => detectCrisisKeywords(msg).detected);
}
```

### CrisisAlert Component

**components/voice/CrisisAlert.tsx:**
```typescript
import { useState } from 'react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import { AlertTriangle, X, Phone, ExternalLink } from 'lucide-react';

interface CrisisAlertProps {
  onDismiss: () => void;
}

export function CrisisAlert({ onDismiss }: CrisisAlertProps) {
  const [showConfirmDismiss, setShowConfirmDismiss] = useState(false);

  const handleCall988 = () => {
    // Track analytics event
    console.log('User clicked Call 988');
    
    // Mobile: initiate phone call
    if ('ontouchstart' in window) {
      window.location.href = 'tel:988';
    } else {
      // Desktop: open 988 website
      window.open('https://988lifeline.org/', '_blank');
    }
  };

  const handleDismiss = () => {
    if (!showConfirmDismiss) {
      setShowConfirmDismiss(true);
      return;
    }
    
    console.log('Crisis alert dismissed');
    onDismiss();
  };

  return (
    <Alert 
      className="fixed top-0 left-0 right-0 z-50 rounded-none border-0 bg-red-600 text-white shadow-lg"
      role="alert"
      aria-live="assertive"
    >
      <div className="container mx-auto flex items-start gap-4 py-4">
        <AlertTriangle className="h-6 w-6 flex-shrink-0 mt-0.5" aria-hidden="true" />
        
        <div className="flex-1 space-y-2">
          <AlertTitle className="text-lg font-bold">
            Crisis Support Available
          </AlertTitle>
          <AlertDescription className="text-white/90">
            If you're experiencing thoughts of suicide or self-harm, help is available 24/7.
          </AlertDescription>
          
          <div className="flex flex-wrap gap-2 mt-3">
            <Button
              onClick={handleCall988}
              size="sm"
              variant="secondary"
              className="bg-white text-red-600 hover:bg-white/90 font-bold"
            >
              <Phone className="mr-2 h-4 w-4" />
              Call 988 (Suicide & Crisis Lifeline)
            </Button>
            
            <Button
              onClick={() => window.open('https://988lifeline.org/chat/', '_blank')}
              size="sm"
              variant="outline"
              className="border-white text-white hover:bg-white/10"
            >
              <ExternalLink className="mr-2 h-4 w-4" />
              Chat Online
            </Button>
          </div>
          
          <p className="text-sm text-white/80 mt-2">
            Campus Counseling Center: Available during business hours
          </p>
        </div>
        
        <Button
          onClick={handleDismiss}
          size="icon"
          variant="ghost"
          className="text-white hover:bg-white/10 flex-shrink-0"
          aria-label="Dismiss alert"
        >
          <X className="h-5 w-5" />
        </Button>
      </div>
      
      {showConfirmDismiss && (
        <div className="container mx-auto mt-2 pb-2 text-sm">
          <p>Are you sure you want to dismiss this? The resources will still be available if you need them.</p>
          <Button
            onClick={handleDismiss}
            size="sm"
            variant="ghost"
            className="mt-2 text-white hover:bg-white/10 underline"
          >
            Yes, dismiss alert
          </Button>
        </div>
      )}
    </Alert>
  );
}
```

### Updated Voice Session Page (with Crisis Detection)

**app/voice-session/page.tsx (additions):**
```typescript
import { detectCrisisKeywords } from '@/lib/detect-crisis';
import { CrisisAlert } from '@/components/voice/CrisisAlert';

function VoiceSessionContent() {
  // ... existing state ...
  const [crisisDetected, setCrisisDetected] = useState(false);
  const [showCrisisAlert, setShowCrisisAlert] = useState(false);

  // Monitor transcript for crisis keywords
  useEffect(() => {
    if (transcript.length === 0) return;

    // Check the most recent user message
    const latestEntry = transcript[transcript.length - 1];
    if (latestEntry.speaker !== 'user') return;

    const result = detectCrisisKeywords(latestEntry.text);
    
    if (result.detected) {
      console.warn('Crisis keywords detected:', result.matchedKeywords);
      setCrisisDetected(true);
      setShowCrisisAlert(true);
      
      // Log for administrative review
      // TODO: Consider sending real-time alert to admin dashboard
    }
  }, [transcript]);

  // ... existing code ...

  return (
    <div className="container mx-auto min-h-screen p-4">
      {/* Crisis Alert Banner */}
      {showCrisisAlert && (
        <CrisisAlert onDismiss={() => setShowCrisisAlert(false)} />
      )}

      {/* Adjust layout padding when alert is visible */}
      <div className={cn(
        "transition-all",
        showCrisisAlert && "pt-24" // Add padding for fixed alert
      )}>
        {/* ... existing session UI ... */}
      </div>
    </div>
  );
}
```

### Updated Bot System Prompts (Crisis Instructions)

Add to each category prompt in Story 3.2:

```python
CRISIS_INSTRUCTION = """

**CRITICAL SAFETY PROTOCOL:**
If the student expresses suicidal thoughts, self-harm ideation, or mentions plans to harm themselves or others:

1. Respond with immediate empathy: "I'm really concerned about what you're sharing. Your safety is the most important thing right now."
2. Provide crisis resources: "Please call or text 988 - the Suicide & Crisis Lifeline. They have trained counselors available 24/7 who can help you right now."
3. Encourage immediate action: "I know it can be hard to reach out, but these counselors are here specifically to help with what you're going through. Can you call them now while we talk?"
4. Do NOT attempt to be a crisis counselor or provide clinical advice.
5. Do NOT minimize their feelings or say "things will get better."
6. Stay with them empathetically until they agree to contact the crisis line or campus resources.

Crisis Resources:
- 988 Suicide & Crisis Lifeline (call or text)
- 988lifeline.org/chat (online chat)
- Campus Counseling Center (business hours)
- Campus Police/Security for immediate emergencies: 911
"""

# Append to each category prompt
HEALTH_PROMPT += CRISIS_INSTRUCTION
CAREER_PROMPT += CRISIS_INSTRUCTION
# ... etc for all categories
```

### Source Tree Updates

```
packages/frontend/
├── app/
│   └── voice-session/
│       └── page.tsx              # Updated with crisis monitoring
├── components/
│   └── voice/
│       └── CrisisAlert.tsx       # Crisis alert banner component
└── lib/
    ├── crisis-keywords.ts        # Keyword list
    └── detect-crisis.ts          # Detection utility functions
```

---

## Testing

### Testing Requirements:

1. **Keyword Detection Tests:**
   ```typescript
   import { detectCrisisKeywords } from '@/lib/detect-crisis';

   describe('Crisis Keyword Detection', () => {
     it('detects suicide keyword', () => {
       const result = detectCrisisKeywords('I am thinking about suicide');
       expect(result.detected).toBe(true);
       expect(result.matchedKeywords).toContain('suicide');
     });

     it('detects self-harm phrases', () => {
       const result = detectCrisisKeywords('I want to hurt myself');
       expect(result.detected).toBe(true);
       expect(result.matchedKeywords).toContain('hurt myself');
     });

     it('detects variations with spacing', () => {
       const result = detectCrisisKeywords('sui cide thoughts');
       expect(result.detected).toBe(true);
     });

     it('is case insensitive', () => {
       const result = detectCrisisKeywords('I want to DIE');
       expect(result.detected).toBe(true);
     });

     it('does not trigger on partial words', () => {
       const result = detectCrisisKeywords('I need to die my hair');
       expect(result.detected).toBe(false);
     });

     it('handles negative context', () => {
       const result = detectCrisisKeywords('I don\'t want to die, I want to live');
       expect(result.detected).toBe(false);
     });

     it('detects multiple keywords', () => {
       const result = detectCrisisKeywords('I have suicidal thoughts and want to hurt myself');
       expect(result.detected).toBe(true);
       expect(result.matchedKeywords.length).toBeGreaterThan(1);
     });
   });
   ```

2. **CrisisAlert Component Test:**
   ```typescript
   it('displays crisis alert with resources', () => {
     const mockDismiss = vi.fn();
     render(<CrisisAlert onDismiss={mockDismiss} />);

     expect(screen.getByText(/crisis support available/i)).toBeInTheDocument();
     expect(screen.getByText(/988/i)).toBeInTheDocument();
     expect(screen.getByRole('button', { name: /call 988/i })).toBeInTheDocument();
   });

   it('requires confirmation before dismissing', () => {
     const mockDismiss = vi.fn();
     render(<CrisisAlert onDismiss={mockDismiss} />);

     const dismissButton = screen.getByLabelText('Dismiss alert');
     fireEvent.click(dismissButton);

     expect(screen.getByText(/are you sure/i)).toBeInTheDocument();
     expect(mockDismiss).not.toHaveBeenCalled();

     // Click again to confirm
     const confirmButton = screen.getByText(/yes, dismiss/i);
     fireEvent.click(confirmButton);

     expect(mockDismiss).toHaveBeenCalled();
   });
   ```

3. **Integration Test:**
   ```typescript
   it('shows crisis alert when crisis keywords detected in transcript', async () => {
     render(<VoiceSessionPage />);

     // Simulate transcript update with crisis content
     const userTranscriptHandler = mockClient.on.mock.calls.find(
       call => call[0] === 'userTranscript'
     )?.[1];

     userTranscriptHandler({ text: 'I am thinking about suicide' });

     await waitFor(() => {
       expect(screen.getByText(/crisis support available/i)).toBeInTheDocument();
     });
   });
   ```

4. **Bot Response Test:**
   ```python
   @pytest.mark.asyncio
   async def test_bot_crisis_response():
       """Test that bot provides crisis resources when prompted."""
       # This would require testing the actual LLM response
       # In practice, you'd use mock responses or test in staging
       pass
   ```

5. **Manual Testing Checklist:**
   - [ ] Type crisis phrase in voice session (via transcript)
   - [ ] Crisis alert banner appears immediately
   - [ ] Alert shows 988 hotline prominently
   - [ ] "Call 988" button works on mobile (initiates call)
   - [ ] "Call 988" button works on desktop (opens website)
   - [ ] "Chat Online" button opens 988 chat
   - [ ] Dismiss requires confirmation
   - [ ] Alert can be re-triggered by new crisis keywords
   - [ ] Crisis flag set in session data
   - [ ] Session saved with crisis_detected=true
   - [ ] Bot responds appropriately to crisis phrases
   - [ ] No false positives for common phrases
   - [ ] Alert is accessible with screen reader
   - [ ] Alert has sufficient color contrast
   - [ ] Test all keywords in CRISIS_KEYWORDS list

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
