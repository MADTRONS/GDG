# Story 4.3: Frontend Video Call Initiation

**Epic:** Epic 4 - Video Calling Integration  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student user,  
**I want** to click Video Call button and immediately connect to a video counselor avatar,  
**so that** I can have a face-to-face counseling session.

---

## Acceptance Criteria

1. Video Call button on CounselorCard has onClick handler that calls handleVideoCall function.
2. Frontend calls POST /api/video/create-room with selected counselor category.
3. On success, frontend receives room credentials (room_url, access_token, session_id) from backend.
4. Loading state displayed during room creation: button shows spinner and text "Connecting to video counselor..."
5. Error handling: if API call fails, display error toast with message and retry button.
6. On room creation success, frontend transitions to video session view at /video-session route.
7. Session ID stored in frontend state for transcript and session history.
8. Video button styled as outline variant to distinguish from voice button (primary variant).
9. Unit tests mock API call and verify navigation on success.

---

## Tasks / Subtasks

- [ ] Update handleVideoCall in CounselorCard component (AC: 1, 2, 4)
  - [ ] Remove placeholder toast notification
  - [ ] Add loading state (isVideoLoading)
  - [ ] Make POST request to /api/video/create-room
  - [ ] Pass counselor category UUID in request body
  - [ ] Handle response data (room_url, access_token, session_id)
  - [ ] Add error handling with try-catch
  
- [ ] Implement navigation to video session page (AC: 6)
  - [ ] Use Next.js router to navigate to /video-session
  - [ ] Pass room credentials via query params
  - [ ] Ensure credentials are not exposed in browser history
  
- [ ] Add error handling and user feedback (AC: 5)
  - [ ] Show error toast on API failure
  - [ ] Include retry button in error message
  - [ ] Log error details to console for debugging
  - [ ] Clear loading state on error
  
- [ ] Prevent duplicate requests (AC: 4)
  - [ ] Disable button while isVideoLoading is true
  - [ ] Add guard clause to prevent multiple simultaneous calls
  - [ ] Show visual feedback (spinner icon replaces video icon)
  
- [ ] Verify authentication requirement
  - [ ] Check useAuth hook for current user
  - [ ] Redirect to login if not authenticated
  - [ ] Show error message if session expired
  
- [ ] Ensure video button styling matches design (AC: 8)
  - [ ] Use Video icon from lucide-react
  - [ ] Button should be outline variant
  - [ ] Spinner icon during loading state
  - [ ] Maintain accessibility (aria-label, keyboard support)
  
- [ ] Write comprehensive tests (AC: 9)
  - [ ] Mock /api/video/create-room API call
  - [ ] Test successful room creation and navigation
  - [ ] Test error scenarios (API failure, network error)
  - [ ] Test loading state behavior
  - [ ] Test authentication requirement
  - [ ] Test duplicate request prevention

---

## Dev Notes

### Architecture Overview

**Video Session Flow:**
1. User clicks video button on counselor card
2. Frontend calls POST /api/video/create-room
3. Backend creates LiveKit room and spawns avatar agent
4. Frontend receives room credentials
5. User navigated to /video-session page
6. Video session page initializes LiveKit client (Story 4.4)

**Difference from Voice (Story 3.3):**
- Endpoint: /api/video/create-room instead of /api/voice/create-room
- Credentials: access_token instead of user_token
- Avatar instead of PipeCat bot

### Updated CounselorCard Component

**Since handleVoiceCall was already implemented in Story 3.3, we just need to update handleVideoCall:**

```typescript
// In app/components/CounselorCard.tsx (update from Story 3.3)

const handleVideoCall = async () => {
  // Guard: prevent duplicate requests
  if (isVideoLoading) return;

  // Guard: check authentication
  if (!user) {
    toast({
      title: "Authentication Required",
      description: "Please log in to start a video session.",
      variant: "destructive"
    });
    router.push('/login');
    return;
  }

  setIsVideoLoading(true);

  try {
    const response = await fetch('/api/v1/video/create-room', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // Include auth cookie
      body: JSON.stringify({
        counselor_category: counselor.id
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to create video session');
    }

    const data = await response.json();
    
    // Navigate to video session page with room credentials
    router.push(
      `/video-session?` +
      `room_url=${encodeURIComponent(data.room_url)}&` +
      `access_token=${encodeURIComponent(data.access_token)}&` +
      `session_id=${encodeURIComponent(data.session_id)}&` +
      `category=${encodeURIComponent(counselor.name)}`
    );

  } catch (error) {
    console.error('Video call initiation error:', error);
    
    toast({
      title: "Connection Failed",
      description: error instanceof Error ? error.message : "Unable to start video session. Please try again.",
      variant: "destructive",
      action: (
        <Button 
          variant="outline" 
          size="sm" 
          onClick={() => handleVideoCall()}
        >
          Retry
        </Button>
      )
    });
  } finally {
    setIsVideoLoading(false);
  }
};
```

### API Client Utility

**lib/api/video.ts:**
```typescript
export interface CreateVideoRoomRequest {
  counselor_category: string; // UUID
}

export interface CreateVideoRoomResponse {
  room_url: string;
  access_token: string;
  room_name: string;
  session_id: string;
}

export async function createVideoRoom(
  categoryId: string
): Promise<CreateVideoRoomResponse> {
  const response = await fetch('/api/v1/video/create-room', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({
      counselor_category: categoryId
    })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || 'Failed to create video room');
  }

  return response.json();
}
```

### Video Session Route Setup

**app/video-session/page.tsx (placeholder for Story 4.4):**
```typescript
'use client';

import { useSearchParams } from 'next/navigation';
import { Suspense } from 'react';

function VideoSessionContent() {
  const searchParams = useSearchParams();
  
  const roomUrl = searchParams.get('room_url');
  const accessToken = searchParams.get('access_token');
  const sessionId = searchParams.get('session_id');
  const category = searchParams.get('category');

  if (!roomUrl || !accessToken || !sessionId) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <p className="text-destructive">Invalid session parameters</p>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-4">
      <h1>Video Session: {category}</h1>
      <p>Room URL: {roomUrl}</p>
      <p>Session ID: {sessionId}</p>
      {/* Story 4.4 will implement LiveKit client connection here */}
    </div>
  );
}

export default function VideoSessionPage() {
  return (
    <Suspense fallback={<div>Loading session...</div>}>
      <VideoSessionContent />
    </Suspense>
  );
}
```

### Source Tree Updates

```
packages/frontend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ CounselorCard.tsx     # Updated with video call logic
â”‚   â””â”€â”€ video-session/
â”‚       â””â”€â”€ page.tsx               # Video session page (Story 4.4)
â””â”€â”€ lib/
    â””â”€â”€ api/
        â””â”€â”€ video.ts               # Video API utilities
```

---

## Testing

### Testing Requirements:

1. **Video Call Initiation Test:**
   ```typescript
   import { render, screen, fireEvent, waitFor } from '@testing-library/react';
   import { vi } from 'vitest';
   import { CounselorCard } from '@/components/CounselorCard';

   describe('CounselorCard Video Call', () => {
     const mockCounselor = {
       id: '123e4567-e89b-12d3-a456-426614174000',
       name: 'Health Counselor',
       description: 'Mental health support',
       icon: 'ðŸ¥',
       enabled: true
     };

     const mockPush = vi.fn();
     const mockUser = { user_id: 'user-123', username: 'testuser' };

     beforeEach(() => {
       vi.mocked(useRouter).mockReturnValue({ push: mockPush } as any);
       global.fetch = vi.fn();
     });

     it('calls API and navigates on successful video call', async () => {
       const mockResponse = {
         room_url: 'wss://livekit.example.com',
         access_token: 'token-123',
         session_id: 'session-456',
       };

       (global.fetch as any).mockResolvedValueOnce({
         ok: true,
         json: async () => mockResponse
       });

       render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const videoButton = screen.getByLabelText(/start video call/i);
       fireEvent.click(videoButton);

       await waitFor(() => {
         expect(global.fetch).toHaveBeenCalledWith(
           '/api/v1/video/create-room',
           expect.objectContaining({
             method: 'POST',
             body: JSON.stringify({ counselor_category: mockCounselor.id })
           })
         );
       });

       await waitFor(() => {
         expect(mockPush).toHaveBeenCalledWith(
           expect.stringContaining('/video-session')
         );
       });
     });

     it('shows loading state during API call', async () => {
       (global.fetch as any).mockImplementation(() => new Promise(() => {}));

       render(
         <AuthProvider value={{ user: mockUser }}>
           <CounselorCard counselor={mockCounselor} />
         </AuthProvider>
       );

       const videoButton = screen.getByLabelText(/start video call/i);
       fireEvent.click(videoButton);

       await waitFor(() => {
         expect(screen.getByText(/connecting/i)).toBeInTheDocument();
         expect(videoButton).toBeDisabled();
       });
     });
   });
   ```

2. **Manual Testing Checklist:**
   - [ ] Video button click initiates API call
   - [ ] Loading spinner shown during API call
   - [ ] Button disabled during loading
   - [ ] Successful API response navigates to /video-session
   - [ ] Room credentials passed in URL params
   - [ ] Error toast shown on API failure
   - [ ] Retry button in error toast works
   - [ ] Unauthenticated users redirected to login
   - [ ] Cannot click video button multiple times
   - [ ] Video button has outline variant styling
   - [ ] Video button distinguishable from voice button

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
