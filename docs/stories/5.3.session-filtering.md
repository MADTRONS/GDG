# Story 5.3: Session Filtering and Search

**Epic:** Epic 5 - Session Management & History  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student,  
**I want** to filter my session history by counselor category and date range,  
**so that** I can quickly find specific past conversations.

---

## Acceptance Criteria

1. Session history page includes filter controls: Category dropdown (All, Health, Career, Academic, etc.), Mode dropdown (All, Voice, Video), Date range picker.
2. Selecting filter options triggers API call to GET /api/sessions with filter parameters.
3. Session list updates to show only matching sessions, maintaining reverse chronological order.
4. Filter state persisted in URL query parameters (e.g., /sessions?category=Health&mode=voice) for shareable/bookmarkable filters.
5. "Clear Filters" button resets all filters and shows full session history.
6. Loading state shown while filtered results fetch.
7. Filter controls keyboard accessible and work with screen readers.

---

## Tasks / Subtasks

- [ ] Filter controls already implemented in Story 5.1 (AC: 1)
  - [ ] Verify category dropdown functional
  - [ ] Verify mode dropdown functional
  - [ ] Add date range picker component
  
- [ ] Implement filter parameter handling (AC: 2)
  - [ ] Update fetchSessions to include filter params
  - [ ] Trigger re-fetch when filters change
  - [ ] Debounce filter changes to reduce API calls
  
- [ ] Update session list display (AC: 3)
  - [ ] Clear existing sessions before loading
  - [ ] Show loading spinner during fetch
  - [ ] Update sessions state with filtered results
  - [ ] Maintain descending sort order
  
- [ ] Implement URL state persistence (AC: 4)
  - [ ] Use Next.js router to update URL params
  - [ ] Read filter state from URL on page load
  - [ ] Use replaceState to avoid history pollution
  - [ ] Make URLs shareable/bookmarkable
  
- [ ] Enhance clear filters functionality (AC: 5)
  - [ ] Reset all filter states
  - [ ] Clear URL parameters
  - [ ] Trigger full session list fetch
  - [ ] Reset pagination to page 1
  
- [ ] Add loading states (AC: 6)
  - [ ] Show skeleton loaders during fetch
  - [ ] Disable filter controls while loading
  - [ ] Show "Filtering..." indicator
  
- [ ] Ensure accessibility (AC: 7)
  - [ ] Add ARIA labels to filter controls
  - [ ] Keyboard navigation support
  - [ ] Screen reader announcements for filter changes
  - [ ] Focus management
  
- [ ] Write comprehensive tests
  - [ ] Test filter state updates
  - [ ] Test URL parameter sync
  - [ ] Test clear filters
  - [ ] Test loading states
  - [ ] Test accessibility

---

## Dev Notes

### Architecture Overview

**Filter Flow:**
```
User selects filter
‚Üì
Update state
‚Üì
Update URL params
‚Üì
Trigger API call with filters
‚Üì
Update session list
```

**URL State Management:**
- Read from URL on mount
- Update URL when filters change
- Share/bookmark filtered views

### Enhanced Session History with Filtering

**app/sessions/page.tsx (enhanced from Story 5.1):**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { useAuth } from '@/lib/auth';
import { Calendar as CalendarIcon } from 'lucide-react';
import { DateRange } from 'react-day-picker';
import { addDays, format } from 'date-fns';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';

export default function SessionHistoryPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { user, loading: authLoading } = useAuth();
  const { toast } = useToast();

  // Initialize filters from URL
  const [categoryFilter, setCategoryFilter] = useState<string>(
    searchParams.get('category') || 'all'
  );
  const [modeFilter, setModeFilter] = useState<string>(
    searchParams.get('mode') || 'all'
  );
  const [dateRange, setDateRange] = useState<DateRange | undefined>(() => {
    const startDate = searchParams.get('start_date');
    const endDate = searchParams.get('end_date');
    if (startDate && endDate) {
      return {
        from: new Date(startDate),
        to: new Date(endDate)
      };
    }
    return undefined;
  });

  const [sessions, setSessions] = useState<Session[]>([]);
  const [loading, setLoading] = useState(true);
  const [totalCount, setTotalCount] = useState(0);
  const [currentPage, setCurrentPage] = useState(1);

  // Update URL when filters change
  useEffect(() => {
    const params = new URLSearchParams();
    
    if (categoryFilter !== 'all') {
      params.set('category', categoryFilter);
    }
    if (modeFilter !== 'all') {
      params.set('mode', modeFilter);
    }
    if (dateRange?.from) {
      params.set('start_date', dateRange.from.toISOString());
    }
    if (dateRange?.to) {
      params.set('end_date', dateRange.to.toISOString());
    }
    if (currentPage > 1) {
      params.set('page', currentPage.toString());
    }

    const paramsString = params.toString();
    const newUrl = paramsString ? `/sessions?${paramsString}` : '/sessions';
    
    router.replace(newUrl, { scroll: false });
  }, [categoryFilter, modeFilter, dateRange, currentPage, router]);

  // Fetch sessions with filters
  const fetchSessions = async () => {
    if (!user) return;
    
    setLoading(true);
    try {
      const params = new URLSearchParams({
        page: currentPage.toString(),
        limit: '20',
      });

      if (categoryFilter !== 'all') {
        params.append('category', categoryFilter);
      }
      if (modeFilter !== 'all') {
        params.append('mode', modeFilter);
      }
      if (dateRange?.from) {
        params.append('start_date', dateRange.from.toISOString());
      }
      if (dateRange?.to) {
        params.append('end_date', dateRange.to.toISOString());
      }

      const response = await fetch(`/api/v1/sessions?${params.toString()}`, {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Failed to fetch sessions');
      }

      const data: SessionsResponse = await response.json();
      setSessions(data.sessions);
      setTotalCount(data.total_count);
    } catch (error) {
      console.error('Error fetching sessions:', error);
      toast({
        title: "Error Loading Sessions",
        description: "Unable to load your session history. Please try again.",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  // Re-fetch when filters change
  useEffect(() => {
    if (user) {
      fetchSessions();
    }
  }, [user, currentPage, categoryFilter, modeFilter, dateRange]);

  // Clear all filters
  const clearFilters = () => {
    setCategoryFilter('all');
    setModeFilter('all');
    setDateRange(undefined);
    setCurrentPage(1);
    
    toast({
      title: "Filters Cleared",
      description: "Showing all sessions"
    });
  };

  // Check if any filters are active
  const hasActiveFilters = () => {
    return categoryFilter !== 'all' || 
           modeFilter !== 'all' || 
           dateRange !== undefined;
  };

  return (
    <div className="container mx-auto p-6 max-w-5xl">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-3xl font-bold mb-2">My Counseling Sessions</h1>
        <p className="text-gray-600">Review your past conversations and track your progress</p>
      </div>

      {/* Filters */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-lg">
            <Filter className="h-5 w-5" />
            Filters
            {hasActiveFilters() && (
              <span className="text-sm font-normal text-blue-600">
                ({totalCount} result{totalCount !== 1 ? 's' : ''})
              </span>
            )}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-4">
            {/* Category Filter */}
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block" htmlFor="category-filter">
                Category
              </label>
              <Select 
                value={categoryFilter} 
                onValueChange={setCategoryFilter}
                aria-label="Filter by counselor category"
              >
                <SelectTrigger id="category-filter">
                  <SelectValue placeholder="All Categories" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Categories</SelectItem>
                  <SelectItem value="Health">üè• Health Counselor</SelectItem>
                  <SelectItem value="Career">üíº Career Counselor</SelectItem>
                  <SelectItem value="Academic">üìö Academic Counselor</SelectItem>
                  <SelectItem value="Financial">üí∞ Financial Counselor</SelectItem>
                  <SelectItem value="Social">ü§ù Social Counselor</SelectItem>
                  <SelectItem value="Personal Development">üå± Personal Development</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Mode Filter */}
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block" htmlFor="mode-filter">
                Mode
              </label>
              <Select 
                value={modeFilter} 
                onValueChange={setModeFilter}
                aria-label="Filter by session mode"
              >
                <SelectTrigger id="mode-filter">
                  <SelectValue placeholder="All Modes" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Modes</SelectItem>
                  <SelectItem value="voice">Voice Only</SelectItem>
                  <SelectItem value="video">Video Call</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Date Range Picker */}
            <div className="flex-1 min-w-[240px]">
              <label className="text-sm font-medium mb-2 block">
                Date Range
              </label>
              <Popover>
                <PopoverTrigger asChild>
                  <Button
                    variant="outline"
                    className={cn(
                      "w-full justify-start text-left font-normal",
                      !dateRange && "text-muted-foreground"
                    )}
                    aria-label="Select date range"
                  >
                    <CalendarIcon className="mr-2 h-4 w-4" />
                    {dateRange?.from ? (
                      dateRange.to ? (
                        <>
                          {format(dateRange.from, "MMM dd, yyyy")} -{" "}
                          {format(dateRange.to, "MMM dd, yyyy")}
                        </>
                      ) : (
                        format(dateRange.from, "MMM dd, yyyy")
                      )
                    ) : (
                      <span>Pick a date range</span>
                    )}
                  </Button>
                </PopoverTrigger>
                <PopoverContent className="w-auto p-0" align="start">
                  <Calendar
                    initialFocus
                    mode="range"
                    defaultMonth={dateRange?.from}
                    selected={dateRange}
                    onSelect={setDateRange}
                    numberOfMonths={2}
                  />
                </PopoverContent>
              </Popover>
            </div>

            {/* Clear Filters */}
            <div className="flex items-end">
              <Button
                variant="outline"
                onClick={clearFilters}
                disabled={!hasActiveFilters()}
                aria-label="Clear all filters"
              >
                Clear Filters
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Loading State */}
      {loading && (
        <div className="text-center py-12">
          <Loader2 className="h-8 w-8 animate-spin mx-auto mb-4 text-blue-600" />
          <p className="text-gray-600">
            {hasActiveFilters() ? 'Filtering sessions...' : 'Loading sessions...'}
          </p>
        </div>
      )}

      {/* Session List or Empty State */}
      {!loading && (
        sessions.length === 0 ? (
          hasActiveFilters() ? (
            <Card className="text-center py-8">
              <CardContent>
                <p className="text-gray-600 mb-4">No sessions found matching your filters.</p>
                <Button variant="link" onClick={clearFilters}>
                  Clear filters to see all sessions
                </Button>
              </CardContent>
            </Card>
          ) : (
            <Card className="text-center py-12">
              <CardContent>
                <Calendar className="h-16 w-16 mx-auto mb-4 text-gray-400" />
                <h2 className="text-xl font-semibold mb-2">No Sessions Yet</h2>
                <p className="text-gray-600 mb-6">
                  You haven't started any counseling sessions yet. Visit your dashboard to get started!
                </p>
                <Button onClick={() => router.push('/dashboard')}>
                  Go to Dashboard
                </Button>
              </CardContent>
            </Card>
          )
        ) : (
          <div className="space-y-4">
            {/* Active Filters Badge */}
            {hasActiveFilters() && (
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <span>Showing {totalCount} filtered result{totalCount !== 1 ? 's' : ''}</span>
              </div>
            )}
            
            {/* Session Cards */}
            {sessions.map((session) => (
              <SessionCard key={session.session_id} session={session} />
            ))}
          </div>
        )
      )}

      {/* Pagination */}
      {/* ... pagination component from Story 5.1 ... */}
    </div>
  );
}
```

### Date Range Picker Component

**components/ui/calendar.tsx:**
```typescript
import * as React from "react";
import { DayPicker } from "react-day-picker";
import { cn } from "@/lib/utils";

export type CalendarProps = React.ComponentProps<typeof DayPicker>;

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell: "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "text-center text-sm p-0 relative",
        day: cn(
          "h-9 w-9 p-0 font-normal",
          "hover:bg-accent hover:text-accent-foreground"
        ),
        day_selected: "bg-primary text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside: "text-muted-foreground opacity-50",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle: "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      {...props}
    />
  );
}
Calendar.displayName = "Calendar";

export { Calendar };
```

### Source Tree Updates

```
packages/frontend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ sessions/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx              # Enhanced with URL state and date range
‚îî‚îÄ‚îÄ components/
    ‚îî‚îÄ‚îÄ ui/
        ‚îú‚îÄ‚îÄ calendar.tsx           # Date range picker
        ‚îî‚îÄ‚îÄ popover.tsx            # Popover for date picker
```

---

## Testing

### Testing Requirements:

1. **Filter State Test:**
   ```typescript
   it('updates session list when filter changes', async () => {
     render(<SessionHistoryPage />);
     
     // Select category filter
     const categorySelect = screen.getByLabelText(/filter by counselor category/i);
     fireEvent.change(categorySelect, { target: { value: 'Health' } });
     
     await waitFor(() => {
       expect(global.fetch).toHaveBeenCalledWith(
         expect.stringContaining('category=Health'),
         expect.any(Object)
       );
     });
   });
   ```

2. **URL Sync Test:**
   ```typescript
   it('persists filter state in URL', async () => {
     const mockReplace = vi.fn();
     vi.mocked(useRouter).mockReturnValue({ replace: mockReplace } as any);
     
     render(<SessionHistoryPage />);
     
     // Set filters
     fireEvent.change(screen.getByLabelText(/category/i), { target: { value: 'Health' } });
     fireEvent.change(screen.getByLabelText(/mode/i), { target: { value: 'voice' } });
     
     await waitFor(() => {
       expect(mockReplace).toHaveBeenCalledWith(
         expect.stringContaining('category=Health&mode=voice'),
         expect.any(Object)
       );
     });
   });
   ```

3. **Clear Filters Test:**
   ```typescript
   it('clears all filters and resets URL', async () => {
     render(<SessionHistoryPage />);
     
     // Set filters
     fireEvent.change(screen.getByLabelText(/category/i), { target: { value: 'Health' } });
     
     // Clear filters
     fireEvent.click(screen.getByText(/clear filters/i));
     
     await waitFor(() => {
       expect(global.fetch).toHaveBeenCalledWith(
         expect.not.stringContaining('category'),
         expect.any(Object)
       );
     });
   });
   ```

4. **Manual Testing Checklist:**
   - [ ] Category filter updates session list
   - [ ] Mode filter updates session list
   - [ ] Date range picker opens and selects dates
   - [ ] Date range filter updates session list
   - [ ] Multiple filters can be combined
   - [ ] Filter state persisted in URL
   - [ ] URL with filters loads correctly on page refresh
   - [ ] Clear filters button resets all filters
   - [ ] Clear filters button disabled when no active filters
   - [ ] Loading state shown during filtering
   - [ ] Empty state shows appropriate message
   - [ ] Result count displays correctly
   - [ ] Keyboard navigation works in filter controls
   - [ ] Screen reader announces filter changes
   - [ ] Mobile responsive layout

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
