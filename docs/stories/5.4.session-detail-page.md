# Story 5.4: Session Detail Page with Full Transcript

**Epic:** Epic 5 - Session Management & History  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student,  
**I want** to view the full transcript of a past session,  
**so that** I can review what was discussed and reflect on the counseling received.

---

## Acceptance Criteria

1. Session detail page created at /sessions/:sessionId route, accessible only to authenticated session owner.
2. Page fetches session data from GET /api/sessions/:sessionId endpoint (requires authentication, returns 403 if user doesn't own session).
3. Page displays session metadata: counselor category, date/time, duration, mode (voice/video).
4. Full transcript rendered as conversation thread: alternating user and counselor messages with timestamps and speaker labels.
5. Messages styled clearly: user messages left-aligned with distinct background color, counselor messages right-aligned, consistent with modern chat UI patterns.
6. Transcript scrollable with timestamps in margin for easy reference.
7. Back button navigates to session history page.
8. Page responsive on mobile with readable font sizes and spacing.

---

## Tasks / Subtasks

- [ ] Create session detail page route (AC: 1)
  - [ ] Create app/sessions/[sessionId]/page.tsx
  - [ ] Add authentication check
  - [ ] Extract sessionId from route params
  
- [ ] Fetch session data (AC: 2)
  - [ ] Call GET /api/sessions/:sessionId on mount
  - [ ] Handle loading state
  - [ ] Handle 403 unauthorized error
  - [ ] Handle 404 not found error
  - [ ] Display error messages to user
  
- [ ] Display session metadata (AC: 3)
  - [ ] Show counselor category with icon
  - [ ] Format date and time
  - [ ] Show session duration
  - [ ] Display mode icon (voice/video)
  - [ ] Show quality metrics if available
  
- [ ] Render full transcript (AC: 4)
  - [ ] Create TranscriptMessage component
  - [ ] Map over transcript array
  - [ ] Display speaker labels
  - [ ] Show message text
  - [ ] Format timestamps
  
- [ ] Style message layout (AC: 5)
  - [ ] User messages: left-aligned, blue background
  - [ ] Counselor messages: right-aligned, gray background
  - [ ] Add avatar/icon for speakers
  - [ ] Rounded corners and padding
  - [ ] Clear visual separation
  
- [ ] Make transcript scrollable (AC: 6)
  - [ ] Set max-height with overflow-y: auto
  - [ ] Add timestamps in margin or inline
  - [ ] Smooth scrolling behavior
  - [ ] Auto-scroll to bottom on load
  
- [ ] Add navigation (AC: 7)
  - [ ] Back button to /sessions
  - [ ] Breadcrumb navigation
  - [ ] Use router.back() or explicit link
  
- [ ] Implement responsive design (AC: 8)
  - [ ] Mobile breakpoint adjustments
  - [ ] Readable font sizes (min 16px)
  - [ ] Adequate touch targets
  - [ ] Stacked layout on mobile
  
- [ ] Write comprehensive tests
  - [ ] Test authentication requirement
  - [ ] Test session data fetch
  - [ ] Test transcript rendering
  - [ ] Test error handling
  - [ ] Test responsive layout

---

## Dev Notes

### Architecture Overview

**Page Structure:**
```
/sessions/:sessionId
â”œâ”€â”€ Back Button
â”œâ”€â”€ Session Metadata Card
â”‚   â”œâ”€â”€ Category
â”‚   â”œâ”€â”€ Date/Time
â”‚   â”œâ”€â”€ Duration
â”‚   â””â”€â”€ Mode
â”œâ”€â”€ Transcript Container
â”‚   â”œâ”€â”€ Message (User)
â”‚   â”œâ”€â”€ Message (Counselor)
â”‚   â”œâ”€â”€ Message (User)
â”‚   â””â”€â”€ ...
â””â”€â”€ Actions (Download, Delete)
```

### Session Detail Page Implementation

**app/sessions/[sessionId]/page.tsx:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { useAuth } from '@/lib/auth';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useToast } from '@/components/ui/use-toast';
import { ArrowLeft, Phone, Video, Clock, Calendar, Loader2 } from 'lucide-react';
import { format } from 'date-fns';
import { cn } from '@/lib/utils';

interface TranscriptMessage {
  timestamp: string;
  speaker: 'user' | 'counselor';
  text: string;
}

interface SessionDetail {
  session_id: string;
  counselor_category: string;
  counselor_icon: string;
  mode: 'voice' | 'video';
  started_at: string;
  ended_at: string;
  duration_seconds: number;
  transcript: TranscriptMessage[];
  quality_metrics?: any;
}

export default function SessionDetailPage() {
  const params = useParams();
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const { toast } = useToast();

  const sessionId = params.sessionId as string;
  const [session, setSession] = useState<SessionDetail | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Redirect if not authenticated
  useEffect(() => {
    if (!authLoading && !user) {
      router.push('/login?redirect=/sessions');
    }
  }, [user, authLoading, router]);

  // Fetch session detail
  useEffect(() => {
    if (!user || !sessionId) return;

    const fetchSession = async () => {
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/v1/sessions/${sessionId}`, {
          credentials: 'include'
        });

        if (response.status === 403) {
          setError('You do not have permission to view this session.');
          return;
        }

        if (response.status === 404) {
          setError('Session not found.');
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to fetch session');
        }

        const data: SessionDetail = await response.json();
        setSession(data);
      } catch (err) {
        console.error('Error fetching session:', err);
        setError('Unable to load session details. Please try again.');
        toast({
          title: "Error Loading Session",
          description: "Unable to load session details. Please try again.",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    fetchSession();
  }, [user, sessionId, toast]);

  // Format duration
  const formatDuration = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
  };

  // Loading state
  if (authLoading || loading) {
    return (
      <div className="container mx-auto p-6 max-w-4xl">
        <div className="flex items-center justify-center py-12">
          <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
        </div>
      </div>
    );
  }

  // Error state
  if (error || !session) {
    return (
      <div className="container mx-auto p-6 max-w-4xl">
        <Button
          variant="ghost"
          onClick={() => router.push('/sessions')}
          className="mb-6"
        >
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back to Sessions
        </Button>
        <Card className="text-center py-12">
          <CardContent>
            <h2 className="text-xl font-semibold mb-2">{error || 'Session Not Found'}</h2>
            <p className="text-gray-600 mb-6">
              The session you're looking for doesn't exist or you don't have permission to view it.
            </p>
            <Button onClick={() => router.push('/sessions')}>
              Return to Session History
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 max-w-4xl">
      {/* Back Button */}
      <Button
        variant="ghost"
        onClick={() => router.push('/sessions')}
        className="mb-6"
      >
        <ArrowLeft className="mr-2 h-4 w-4" />
        Back to Sessions
      </Button>

      {/* Session Metadata Card */}
      <Card className="mb-6">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-4xl">{session.counselor_icon}</span>
              <div>
                <CardTitle>{session.counselor_category}</CardTitle>
                <CardDescription>
                  Session on {format(new Date(session.started_at), 'MMMM d, yyyy â€¢ h:mm a')}
                </CardDescription>
              </div>
            </div>
            {session.mode === 'video' ? (
              <Video className="h-6 w-6 text-purple-600" />
            ) : (
              <Phone className="h-6 w-6 text-blue-600" />
            )}
          </div>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-6 text-sm">
            <div className="flex items-center gap-2">
              <Calendar className="h-4 w-4 text-gray-500" />
              <span className="text-gray-700">
                {format(new Date(session.started_at), 'PPP')}
              </span>
            </div>
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4 text-gray-500" />
              <span className="text-gray-700">
                Duration: {formatDuration(session.duration_seconds)}
              </span>
            </div>
            {session.quality_metrics && (
              <div className="flex items-center gap-2">
                <span className="text-gray-500">Quality:</span>
                <span className="text-gray-700">
                  {session.quality_metrics.connection_quality_average || 'Good'}
                </span>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Transcript */}
      <Card>
        <CardHeader>
          <CardTitle>Conversation Transcript</CardTitle>
          <CardDescription>
            Full recording of your counseling session
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4 max-h-[600px] overflow-y-auto pr-4">
            {session.transcript && session.transcript.length > 0 ? (
              session.transcript.map((message, index) => (
                <TranscriptMessage
                  key={index}
                  message={message}
                  isUser={message.speaker === 'user'}
                />
              ))
            ) : (
              <p className="text-center text-gray-500 py-8">
                No transcript available for this session.
              </p>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Action Buttons (Story 5.6, 5.7) */}
      <div className="mt-6 flex gap-4">
        {/* Download and Delete buttons will be added in Stories 5.6 and 5.7 */}
      </div>
    </div>
  );
}

function TranscriptMessage({ message, isUser }: { message: TranscriptMessage; isUser: boolean }) {
  return (
    <div
      className={cn(
        "flex",
        isUser ? "justify-start" : "justify-end"
      )}
    >
      <div
        className={cn(
          "max-w-[75%] rounded-lg p-4 shadow-sm",
          isUser
            ? "bg-blue-100 text-blue-900"
            : "bg-gray-100 text-gray-900"
        )}
      >
        <div className="flex items-center gap-2 mb-1">
          <span className="font-semibold text-sm">
            {isUser ? 'You' : 'Counselor'}
          </span>
          <span className="text-xs text-gray-500">
            {format(new Date(message.timestamp), 'h:mm a')}
          </span>
        </div>
        <p className="text-sm leading-relaxed whitespace-pre-wrap">
          {message.text}
        </p>
      </div>
    </div>
  );
}
```

### Source Tree Updates

```
packages/frontend/
â””â”€â”€ app/
    â””â”€â”€ sessions/
        â””â”€â”€ [sessionId]/
            â””â”€â”€ page.tsx          # Session detail page
```

---

## Testing

### Testing Requirements:

1. **Authentication Test:**
   ```typescript
   it('redirects to login if not authenticated', async () => {
     const mockPush = vi.fn();
     vi.mocked(useRouter).mockReturnValue({ push: mockPush } as any);
     vi.mocked(useAuth).mockReturnValue({ user: null, loading: false });

     render(<SessionDetailPage />);

     await waitFor(() => {
       expect(mockPush).toHaveBeenCalledWith('/login?redirect=/sessions');
     });
   });
   ```

2. **Session Fetch Test:**
   ```typescript
   it('fetches and displays session details', async () => {
     const mockSession = {
       session_id: '123',
       counselor_category: 'Health Counselor',
       counselor_icon: 'ðŸ¥',
       mode: 'voice',
       started_at: '2025-12-20T10:00:00Z',
       ended_at: '2025-12-20T10:15:00Z',
       duration_seconds: 900,
       transcript: [
         { timestamp: '2025-12-20T10:00:00Z', speaker: 'user', text: 'Hello' },
         { timestamp: '2025-12-20T10:00:05Z', speaker: 'counselor', text: 'Hi there!' }
       ]
     };

     global.fetch = vi.fn().mockResolvedValue({
       ok: true,
       json: async () => mockSession
     });

     render(<SessionDetailPage />);

     await waitFor(() => {
       expect(screen.getByText('Health Counselor')).toBeInTheDocument();
       expect(screen.getByText('Hello')).toBeInTheDocument();
       expect(screen.getByText('Hi there!')).toBeInTheDocument();
     });
   });
   ```

3. **Authorization Error Test:**
   ```typescript
   it('shows error for unauthorized access', async () => {
     global.fetch = vi.fn().mockResolvedValue({
       ok: false,
       status: 403
     });

     render(<SessionDetailPage />);

     await waitFor(() => {
       expect(screen.getByText(/permission/i)).toBeInTheDocument();
     });
   });
   ```

4. **Manual Testing Checklist:**
   - [ ] Page requires authentication
   - [ ] Session detail fetched on load
   - [ ] Metadata displayed correctly
   - [ ] Counselor icon and category shown
   - [ ] Date/time formatted properly
   - [ ] Duration calculated correctly
   - [ ] Mode icon displayed (voice/video)
   - [ ] Transcript messages rendered
   - [ ] User messages left-aligned, blue background
   - [ ] Counselor messages right-aligned, gray background
   - [ ] Timestamps shown for each message
   - [ ] Transcript scrollable
   - [ ] Back button navigates to session list
   - [ ] 403 error shows appropriate message
   - [ ] 404 error shows appropriate message
   - [ ] Responsive layout on mobile
   - [ ] Font sizes readable (16px+)
   - [ ] Touch targets adequate size

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
