# Story 5.6: Download Transcript Feature

**Epic:** Epic 5 - Session Management & History  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** student,  
**I want** to download my session transcript as a text file,  
**so that** I can keep a personal copy for reflection or share with my personal therapist.

---

## Acceptance Criteria

1. Session detail page includes "Download Transcript" button below transcript content.
2. Clicking button triggers download of plain text file formatted as: Session_[Category]_[Date].txt.
3. File content includes: session metadata header (category, date, duration) followed by formatted transcript (speaker labels, timestamps, message text).
4. Download implemented client-side using Blob API and anchor element download attribute (no backend endpoint needed).
5. Button accessible via keyboard and screen reader announces action.

---

## Tasks / Subtasks

- [ ] Add Download Transcript button to session detail page (AC: 1)
  - [ ] Place button below transcript content
  - [ ] Use Download icon from lucide-react
  - [ ] Style as secondary/outline button
  
- [ ] Implement download function (AC: 2, 3, 4)
  - [ ] Format session metadata as header
  - [ ] Format transcript messages with speaker labels
  - [ ] Include timestamps for each message
  - [ ] Create Blob from formatted text
  - [ ] Generate filename with category and date
  - [ ] Trigger download using anchor element
  
- [ ] Ensure accessibility (AC: 5)
  - [ ] Add aria-label to button
  - [ ] Keyboard accessible (Tab + Enter)
  - [ ] Screen reader announces "Download transcript"
  - [ ] Focus visible indicator
  
- [ ] Write comprehensive tests
  - [ ] Test download function creates blob
  - [ ] Test filename format
  - [ ] Test file content structure
  - [ ] Test accessibility attributes

---

## Dev Notes

### Architecture Overview

**Download Flow:**
```
User clicks "Download"
↓
Format session data as text
↓
Create Blob from text
↓
Create temporary anchor element
↓
Set download attribute with filename
↓
Programmatically click anchor
↓
File downloads to user's device
```

### Enhanced Session Detail Page with Download

**app/sessions/[sessionId]/page.tsx (add to existing file):**
```typescript
import { Download } from 'lucide-react';
import { format } from 'date-fns';

export default function SessionDetailPage() {
  // ... existing code ...

  // Download transcript function
  const downloadTranscript = () => {
    if (!session) return;

    // Format session metadata
    const header = `
======================================
COUNSELING SESSION TRANSCRIPT
======================================

Counselor Category: ${session.counselor_category}
Session Mode: ${session.mode === 'video' ? 'Video Call' : 'Voice Call'}
Date: ${format(new Date(session.started_at), 'PPPP')}
Time: ${format(new Date(session.started_at), 'p')}
Duration: ${formatDuration(session.duration_seconds)}
Session ID: ${session.session_id}

======================================
TRANSCRIPT
======================================

`;

    // Format transcript messages
    const transcript = session.transcript
      .map(msg => {
        const timestamp = format(new Date(msg.timestamp), 'h:mm:ss a');
        const speaker = msg.speaker === 'user' ? 'YOU' : 'COUNSELOR';
        return `[${timestamp}] ${speaker}:\n${msg.text}\n`;
      })
      .join('\n');

    // Combine content
    const content = header + transcript;

    // Create blob
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });

    // Generate filename
    const dateStr = format(new Date(session.started_at), 'yyyy-MM-dd');
    const categorySlug = session.counselor_category.replace(/\s+/g, '_');
    const filename = `Session_${categorySlug}_${dateStr}.txt`;

    // Create download link
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';

    // Trigger download
    document.body.appendChild(link);
    link.click();

    // Cleanup
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // Show success toast
    toast({
      title: "Transcript Downloaded",
      description: `Saved as ${filename}`
    });
  };

  return (
    <div className="container mx-auto p-6 max-w-4xl">
      {/* ... existing session metadata and transcript ... */}

      {/* Action Buttons */}
      <div className="mt-6 flex flex-wrap gap-4">
        <Button
          onClick={downloadTranscript}
          variant="outline"
          size="lg"
          aria-label="Download transcript as text file"
        >
          <Download className="mr-2 h-5 w-5" />
          Download Transcript
        </Button>
        {/* Delete button from Story 5.7 will go here */}
      </div>
    </div>
  );
}
```

### Example Downloaded File Format

**Session_Health_Counselor_2025-12-20.txt:**
```
======================================
COUNSELING SESSION TRANSCRIPT
======================================

Counselor Category: Health Counselor
Session Mode: Voice Call
Date: Friday, December 20, 2025
Time: 10:00 AM
Duration: 15m 30s
Session ID: 123e4567-e89b-12d3-a456-426614174000

======================================
TRANSCRIPT
======================================

[10:00:00 AM] YOU:
I've been feeling really stressed lately with finals coming up.

[10:00:15 AM] COUNSELOR:
I understand finals can be a very stressful time. Can you tell me more about what's been causing you the most stress?

[10:00:45 AM] YOU:
I have three exams in one week and I'm worried I won't have enough time to study for all of them.

[10:01:10 AM] COUNSELOR:
Let's work on creating a study schedule together. Breaking it down into manageable chunks can help reduce that overwhelming feeling.

...
```

### Utility Function (Optional)

**lib/download.ts:**
```typescript
export function downloadTextFile(content: string, filename: string) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.style.display = 'none';
  
  document.body.appendChild(link);
  link.click();
  
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

### Source Tree Updates

```
packages/frontend/
├── app/
│   └── sessions/
│       └── [sessionId]/
│           └── page.tsx          # Add download function
└── lib/
    └── download.ts               # Optional utility
```

---

## Testing

### Testing Requirements:

1. **Download Function Test:**
   ```typescript
   import { render, screen, fireEvent } from '@testing-library/react';
   import SessionDetailPage from '@/app/sessions/[sessionId]/page';

   describe('Download Transcript', () => {
     it('creates blob and triggers download', async () => {
       const createObjectURLMock = vi.fn(() => 'blob:mock-url');
       global.URL.createObjectURL = createObjectURLMock;
       global.URL.revokeObjectURL = vi.fn();

       const mockSession = {
         session_id: '123',
         counselor_category: 'Health Counselor',
         mode: 'voice',
         started_at: '2025-12-20T10:00:00Z',
         duration_seconds: 900,
         transcript: [
           { timestamp: '2025-12-20T10:00:00Z', speaker: 'user', text: 'Hello' }
         ]
       };

       render(<SessionDetailPage />);

       // Simulate session loaded
       // ...

       const downloadButton = screen.getByLabelText(/download transcript/i);
       fireEvent.click(downloadButton);

       expect(createObjectURLMock).toHaveBeenCalled();
       // Check that anchor element was created and clicked
     });
   });
   ```

2. **Filename Format Test:**
   ```typescript
   it('generates correct filename format', () => {
     const session = {
       counselor_category: 'Health Counselor',
       started_at: '2025-12-20T10:00:00Z'
     };

     const expectedFilename = 'Session_Health_Counselor_2025-12-20.txt';
     // Test filename generation logic
   });
   ```

3. **File Content Test:**
   ```typescript
   it('formats transcript content correctly', () => {
     const session = {
       counselor_category: 'Health Counselor',
       started_at: '2025-12-20T10:00:00Z',
       duration_seconds: 930,
       transcript: [
         { timestamp: '2025-12-20T10:00:00Z', speaker: 'user', text: 'Hello' },
         { timestamp: '2025-12-20T10:00:05Z', speaker: 'counselor', text: 'Hi there!' }
       ]
     };

     // Generate content
     // Verify header contains metadata
     // Verify transcript contains messages
     // Verify timestamps formatted correctly
   });
   ```

4. **Manual Testing Checklist:**
   - [ ] Download button visible on session detail page
   - [ ] Button positioned below transcript
   - [ ] Clicking button downloads file
   - [ ] Filename format correct: Session_Category_Date.txt
   - [ ] File contains session metadata header
   - [ ] File contains formatted transcript
   - [ ] Timestamps included for each message
   - [ ] Speaker labels clear (YOU vs COUNSELOR)
   - [ ] Text encoding UTF-8 (supports special characters)
   - [ ] File opens correctly in text editors
   - [ ] Success toast shown after download
   - [ ] Button keyboard accessible (Tab + Enter)
   - [ ] Screen reader announces button action
   - [ ] Focus visible on button
   - [ ] Works on mobile devices

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
