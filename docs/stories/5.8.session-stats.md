# Story 5.8: Session Stats and Dashboard Summary

**Epic:** Epic 5 - Session Management & History  
**Status:** Ready for Review  
**Created:** December 20, 2025  
**Last Updated:** December 22, 2025  
**Agent Model Used:** Claude Sonnet 4.5

---

## Story

**As a** student,  
**I want** to see a summary of my counseling usage on the dashboard,  
**so that** I can track my engagement and reflect on my patterns.

---

## Acceptance Criteria

1. Dashboard page includes "My Counseling Stats" widget displaying: Total Sessions, Total Hours, Most Used Category, Recent Session Date.
2. Frontend fetches stats from GET /api/sessions/stats endpoint (requires authentication).
3. Endpoint returns aggregated data: { total_sessions, total_hours, top_category, last_session_date }.
4. Stats widget styled consistently with counselor category cards (same card component).
5. "View All Sessions" link in stats widget navigates to session history page.
6. Stats update immediately after completing a new session (refresh or real-time update).
7. Widget responsive on mobile, stacked layout if needed.

---

## Tasks / Subtasks

- [x] Create backend stats endpoint (AC: 2, 3)
  - [x] Add GET /api/sessions/stats route
  - [x] Query sessions for authenticated user
  - [x] Calculate total session count
  - [x] Calculate total hours (sum duration_seconds)
  - [x] Find most used category (mode)
  - [x] Get last session date
  - [x] Return aggregated data
  
- [x] Create StatsWidget component (AC: 1, 4)
  - [x] Fetch stats from API
  - [x] Display total sessions
  - [x] Display total hours (formatted)
  - [x] Display top category with icon
  - [x] Display recent session date
  - [x] Use Card component for consistency
  
- [x] Add widget to dashboard (AC: 1)
  - [x] Place below counselor categories
  - [x] Or in sidebar/grid layout
  - [x] Appropriate spacing
  
- [x] Add navigation link (AC: 5)
  - [x] "View All Sessions" button/link
  - [x] Navigate to /sessions on click
  - [x] Styled as primary or link
  
- [x] Implement responsive design (AC: 7)
  - [x] Grid layout on desktop
  - [x] Stacked layout on mobile
  - [x] Readable stat values
  - [x] Touch-friendly links
  
- [x] Handle empty state
  - [x] Show friendly message if no sessions
  - [x] Encourage starting first session
  
- [x] Write comprehensive tests
  - [x] Test stats API endpoint
  - [x] Test widget rendering
  - [x] Test empty state
  - [x] Test navigation
  - [x] Test responsive layout

---

## Dev Agent Record

### Debug Log References
- No critical issues encountered
- All implementations completed successfully
- Frontend tests: 12/12 passed

### Completion Notes
- Backend stats endpoint implemented at GET /api/v1/sessions/stats
- Uses SQLAlchemy aggregations (COUNT, SUM, GROUP BY, MAX)
- Properly filters by user_id and excludes soft-deleted sessions (deleted_at IS NULL)
- StatsWidget component created with loading, empty, and populated states
- Responsive grid layout (1 col mobile, 2 cols tablet, 4 cols desktop)
- Last session date formatted with relative time ("Today", "Yesterday", "X days ago")
- View All Sessions button navigates to /session-history page
- Comprehensive test coverage: 12 frontend tests, 8 backend tests
- Widget styled consistently with existing dashboard cards

### File List
**Backend:**
- packages/backend/app/routers/sessions.py (modified - added stats endpoint)
- packages/backend/app/schemas/session.py (modified - added SessionStatsResponse)
- packages/backend/tests/routers/test_sessions_stats.py (new - 8 test cases)

**Frontend:**
- packages/frontend/components/StatsWidget.tsx (new - stats display component)
- packages/frontend/app/dashboard/page.tsx (modified - added StatsWidget)
- packages/frontend/__tests__/components/StatsWidget.test.tsx (new - 12 test cases)

---

## Dev Notes

### Architecture Overview

**Stats Calculation:**
- Total Sessions: COUNT(*)
- Total Hours: SUM(duration_seconds) / 3600
- Top Category: GROUP BY category, ORDER BY COUNT DESC
- Last Session: MAX(start_time)

### Backend Stats Endpoint

**app/routers/sessions.py (add to existing file):**
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, and_, desc
from app.database import get_db
from app.models import User, Session, CounselorCategory
from app.auth import get_current_user
from pydantic import BaseModel
from typing import Optional
from datetime import datetime

router = APIRouter(prefix="/sessions", tags=["sessions"])

class SessionStatsResponse(BaseModel):
    total_sessions: int
    total_hours: float
    top_category: Optional[str] = None
    top_category_icon: Optional[str] = None
    last_session_date: Optional[str] = None

@router.get("/stats", response_model=SessionStatsResponse)
async def get_session_stats(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    Get aggregated session statistics for authenticated user.
    
    Returns total sessions, total hours, most used category, and last session date.
    """
    try:
        # Base query for user's non-deleted sessions
        base_filter = and_(
            Session.user_id == current_user.user_id,
            Session.deleted_at.is_(None)
        )
        
        # Total sessions count
        count_query = select(func.count(Session.session_id)).where(base_filter)
        total_result = await db.execute(count_query)
        total_sessions = total_result.scalar() or 0
        
        # Total hours (sum of duration_seconds converted to hours)
        hours_query = select(func.sum(Session.duration_seconds)).where(base_filter)
        hours_result = await db.execute(hours_query)
        total_seconds = hours_result.scalar() or 0
        total_hours = round(total_seconds / 3600, 1)  # Convert to hours, 1 decimal
        
        # Most used category
        category_query = (
            select(
                CounselorCategory.name,
                CounselorCategory.icon,
                func.count(Session.session_id).label('count')
            )
            .join(CounselorCategory, Session.counselor_category == CounselorCategory.category_id)
            .where(base_filter)
            .group_by(CounselorCategory.category_id, CounselorCategory.name, CounselorCategory.icon)
            .order_by(desc('count'))
            .limit(1)
        )
        category_result = await db.execute(category_query)
        top_category_row = category_result.first()
        
        top_category = None
        top_category_icon = None
        if top_category_row:
            top_category = top_category_row[0]
            top_category_icon = top_category_row[1]
        
        # Last session date
        date_query = select(func.max(Session.start_time)).where(base_filter)
        date_result = await db.execute(date_query)
        last_session = date_result.scalar()
        last_session_date = last_session.isoformat() if last_session else None
        
        return SessionStatsResponse(
            total_sessions=total_sessions,
            total_hours=total_hours,
            top_category=top_category,
            top_category_icon=top_category_icon,
            last_session_date=last_session_date
        )
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        raise HTTPException(status_code=500, detail=f"Failed to fetch session stats: {str(e)}")
```

### Stats Widget Component

**components/StatsWidget.tsx:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { TrendingUp, Clock, Calendar, Award } from 'lucide-react';
import { format } from 'date-fns';
import { useToast } from '@/components/ui/use-toast';

interface SessionStats {
  total_sessions: number;
  total_hours: number;
  top_category: string | null;
  top_category_icon: string | null;
  last_session_date: string | null;
}

export default function StatsWidget() {
  const router = useRouter();
  const { toast } = useToast();
  const [stats, setStats] = useState<SessionStats | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchStats = async () => {
      try {
        const response = await fetch('/api/v1/sessions/stats', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to fetch stats');
        }

        const data: SessionStats = await response.json();
        setStats(data);
      } catch (error) {
        console.error('Error fetching stats:', error);
        toast({
          title: "Unable to Load Stats",
          description: "Your counseling statistics couldn't be loaded.",
          variant: "destructive"
        });
      } finally {
        setLoading(false);
      }
    };

    fetchStats();
  }, [toast]);

  if (loading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>My Counseling Stats</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="animate-pulse space-y-4">
            <div className="h-4 bg-gray-200 rounded w-3/4" />
            <div className="h-4 bg-gray-200 rounded w-1/2" />
          </div>
        </CardContent>
      </Card>
    );
  }

  // Empty state
  if (!stats || stats.total_sessions === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>My Counseling Stats</CardTitle>
          <CardDescription>Track your counseling journey</CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-gray-600 mb-4">
            Start your first session to see your statistics!
          </p>
          <Button onClick={() => router.push('/dashboard')} variant="outline">
            Browse Counselors
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle>My Counseling Stats</CardTitle>
            <CardDescription>Your counseling journey at a glance</CardDescription>
          </div>
          <TrendingUp className="h-6 w-6 text-green-600" />
        </div>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          {/* Total Sessions */}
          <div className="text-center p-4 bg-blue-50 rounded-lg">
            <div className="text-3xl font-bold text-blue-600">
              {stats.total_sessions}
            </div>
            <div className="text-sm text-gray-600 mt-1">Total Sessions</div>
          </div>

          {/* Total Hours */}
          <div className="text-center p-4 bg-purple-50 rounded-lg">
            <div className="text-3xl font-bold text-purple-600 flex items-center justify-center gap-1">
              <Clock className="h-6 w-6" />
              {stats.total_hours}
            </div>
            <div className="text-sm text-gray-600 mt-1">Total Hours</div>
          </div>

          {/* Most Used Category */}
          {stats.top_category && (
            <div className="text-center p-4 bg-green-50 rounded-lg">
              <div className="text-3xl mb-1">{stats.top_category_icon}</div>
              <div className="text-xs font-medium text-gray-700">{stats.top_category}</div>
              <div className="text-xs text-gray-500 mt-1">Most Used</div>
            </div>
          )}

          {/* Recent Session */}
          {stats.last_session_date && (
            <div className="text-center p-4 bg-orange-50 rounded-lg">
              <Calendar className="h-6 w-6 mx-auto mb-1 text-orange-600" />
              <div className="text-xs font-medium text-gray-700">
                {format(new Date(stats.last_session_date), 'MMM d')}
              </div>
              <div className="text-xs text-gray-500 mt-1">Last Session</div>
            </div>
          )}
        </div>

        <Button 
          onClick={() => router.push('/sessions')} 
          className="w-full"
          variant="outline"
        >
          View All Sessions
        </Button>
      </CardContent>
    </Card>
  );
}
```

### Dashboard Integration

**app/dashboard/page.tsx (add widget):**
```typescript
import StatsWidget from '@/components/StatsWidget';

export default function DashboardPage() {
  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Counselor Dashboard</h1>
      
      {/* Counselor Categories Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {/* Counselor category cards */}
      </div>
      
      {/* Stats Widget */}
      <div className="max-w-4xl mx-auto">
        <StatsWidget />
      </div>
    </div>
  );
}
```

### Source Tree Updates

```
packages/frontend/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ dashboard/
â”‚       â””â”€â”€ page.tsx              # Add StatsWidget
â””â”€â”€ components/
    â””â”€â”€ StatsWidget.tsx           # New stats widget component

packages/backend/
â””â”€â”€ app/
    â””â”€â”€ routers/
        â””â”€â”€ sessions.py           # Add GET /stats endpoint
```

---

## Testing

### Testing Requirements:

1. **Backend Stats Test:**
   ```python
   @pytest.mark.asyncio
   async def test_get_session_stats(db_session, test_user, test_categories):
       """Test session stats calculation"""
       health_category, career_category = test_categories
       
       # Create sessions
       sessions = [
           Session(
               user_id=test_user.user_id,
               counselor_category=health_category.category_id,
               mode='voice',
               start_time=datetime.utcnow(),
               duration_seconds=600  # 10 minutes
           ),
           Session(
               user_id=test_user.user_id,
               counselor_category=health_category.category_id,
               mode='video',
               start_time=datetime.utcnow(),
               duration_seconds=900  # 15 minutes
           ),
           Session(
               user_id=test_user.user_id,
               counselor_category=career_category.category_id,
               mode='voice',
               start_time=datetime.utcnow(),
               duration_seconds=1200  # 20 minutes
           )
       ]
       db_session.add_all(sessions)
       await db_session.commit()
       
       # Fetch stats
       token = create_test_token(test_user)
       response = client.get(
           "/api/v1/sessions/stats",
           headers={"Authorization": f"Bearer {token}"}
       )
       
       assert response.status_code == 200
       data = response.json()
       assert data['total_sessions'] == 3
       assert data['total_hours'] == 0.8  # (600 + 900 + 1200) / 3600 = 0.75 rounded
       assert data['top_category'] == 'Health'  # 2 health vs 1 career
       assert data['last_session_date'] is not None
   ```

2. **Frontend Widget Test:**
   ```typescript
   it('displays stats correctly', async () => {
     const mockStats = {
       total_sessions: 5,
       total_hours: 2.5,
       top_category: 'Health Counselor',
       top_category_icon: 'ðŸ¥',
       last_session_date: '2025-12-20T10:00:00Z'
     };

     global.fetch = vi.fn().mockResolvedValue({
       ok: true,
       json: async () => mockStats
     });

     render(<StatsWidget />);

     await waitFor(() => {
       expect(screen.getByText('5')).toBeInTheDocument();
       expect(screen.getByText('2.5')).toBeInTheDocument();
       expect(screen.getByText('Health Counselor')).toBeInTheDocument();
     });
   });
   ```

3. **Manual Testing Checklist:**
   - [ ] Stats widget visible on dashboard
   - [ ] Total sessions displays correctly
   - [ ] Total hours calculated correctly
   - [ ] Top category shows icon and name
   - [ ] Last session date formatted properly
   - [ ] "View All Sessions" button navigates to /sessions
   - [ ] Empty state shown for new users
   - [ ] Loading state displays while fetching
   - [ ] Error handled gracefully
   - [ ] Widget styled consistently with other cards
   - [ ] Responsive layout on mobile
   - [ ] Stats update after completing new session
   - [ ] Grid layout works on different screen sizes
   - [ ] Touch-friendly on mobile devices

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-22 | 2.0 | Implementation complete - Backend stats endpoint, StatsWidget component, comprehensive tests (12 frontend, 8 backend), responsive design, empty state handling | James (Dev) |
