# Story 6.2: Counselor Category Management Interface

**Epic:** Epic 6 - Admin Dashboard & Counselor Management  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** content manager,  
**I want** to create, edit, and disable counselor categories through an admin UI,  
**so that** I can adjust available counseling options without developer assistance.

---

## Acceptance Criteria

1. GET /api/admin/counselors/categories endpoint returns all categories including disabled ones (admins only).
2. POST /api/admin/counselors/categories endpoint creates new category with validation.
3. PUT /api/admin/counselors/categories/{id} endpoint updates existing category.
4. DELETE /api/admin/counselors/categories/{id} soft deletes category (sets enabled=false).
5. Admin UI page at /admin/counselors displays table of all categories with edit/disable actions.
6. Create/Edit modal form includes fields: name, description, icon_name, system_prompt, enabled toggle.
7. System prompt field includes syntax highlighting and validation for length limits.
8. Changes to enabled status immediately reflected in student dashboard (cached data refreshed).
9. Audit log entry created for every category modification with admin user ID and timestamp.
10. Frontend displays success/error toast notifications for all CRUD operations.

---

## Tasks / Subtasks

- [ ] Create admin counselor endpoints (AC: 1, 2, 3, 4)
  - [ ] Add GET /api/admin/counselors/categories
  - [ ] Add POST /api/admin/counselors/categories
  - [ ] Add PUT /api/admin/counselors/categories/{id}
  - [ ] Add DELETE /api/admin/counselors/categories/{id}
  - [ ] Apply admin authentication middleware
  - [ ] Validate input data (Pydantic models)
  
- [ ] Implement audit logging (AC: 9)
  - [ ] Create AuditLog model
  - [ ] Log CREATE action on category creation
  - [ ] Log UPDATE action on category modification
  - [ ] Log DELETE action on disable
  - [ ] Include admin_user_id and timestamp
  
- [ ] Build counselor management page (AC: 5)
  - [ ] Create /admin/counselors route
  - [ ] Fetch all categories (including disabled)
  - [ ] Display in table with columns: name, icon, enabled, actions
  - [ ] Add "Create Category" button
  
- [ ] Create category form modal (AC: 6, 7)
  - [ ] Modal dialog for create/edit
  - [ ] Input fields: name, description, icon, system_prompt
  - [ ] Toggle switch for enabled status
  - [ ] Syntax highlighting for system prompt (monaco editor or textarea with validation)
  - [ ] Character count for system prompt
  - [ ] Form validation
  
- [ ] Implement CRUD operations (AC: 10)
  - [ ] Create new category
  - [ ] Edit existing category
  - [ ] Disable category (soft delete)
  - [ ] Display success/error toasts
  - [ ] Refresh table after operation
  
- [ ] Handle cache invalidation (AC: 8)
  - [ ] Clear student dashboard cache on category change
  - [ ] Or use cache TTL to auto-refresh
  - [ ] Verify changes reflected in student view
  
- [ ] Write comprehensive tests
  - [ ] Test all CRUD endpoints
  - [ ] Test authorization (content manager access)
  - [ ] Test audit log creation
  - [ ] Test form validation
  - [ ] Test UI interactions

---

## Dev Notes

### Architecture Overview

**CRUD Flow:**
```
Admin opens /admin/counselors
â†“
Fetch all categories (including disabled)
â†“
Display in table
â†“
Admin clicks "Edit" or "Create"
â†“
Modal form appears
â†“
Admin submits form
â†“
API call (POST/PUT/DELETE)
â†“
Audit log entry created
â†“
Success toast displayed
â†“
Table refreshed
â†“
Student dashboard cache cleared
```

### Audit Log Model

**app/models.py (add AuditLog model):**
```python
from sqlalchemy import Column, String, DateTime, ForeignKey, Text, Enum
from sqlalchemy.dialects.postgresql import UUID, JSONB
from datetime import datetime
import uuid
import enum

class AuditAction(str, enum.Enum):
    CREATE = "CREATE"
    UPDATE = "UPDATE"
    DELETE = "DELETE"
    LOGIN = "LOGIN"
    LOGOUT = "LOGOUT"

class AuditLog(Base):
    __tablename__ = "audit_log"
    
    log_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    admin_user_id = Column(UUID(as_uuid=True), ForeignKey("admin_users.admin_id"), nullable=False)
    action = Column(Enum(AuditAction), nullable=False)
    resource_type = Column(String(50), nullable=False)  # e.g., "CounselorCategory", "AdminUser"
    resource_id = Column(UUID(as_uuid=True), nullable=True)  # ID of affected resource
    details = Column(JSONB, nullable=True)  # Additional context (e.g., changed fields)
    ip_address = Column(String(45), nullable=True)  # IPv4 or IPv6
    timestamp = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    
    def __repr__(self):
        return f"<AuditLog {self.action.value} {self.resource_type} by {self.admin_user_id}>"
```

### Backend Admin Counselor Router

**app/routers/admin_counselors.py (new file):**
```python
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from app.database import get_db
from app.models import CounselorCategory, Admin, AuditLog, AuditAction, AdminRole
from app.auth import get_current_admin, require_admin_role
from pydantic import BaseModel
from typing import List, Optional
import uuid

router = APIRouter(prefix="/admin/counselors", tags=["admin-counselors"])

class CategoryResponse(BaseModel):
    category_id: str
    name: str
    description: str
    icon: str
    system_prompt: str
    enabled: bool

class CategoryCreateRequest(BaseModel):
    name: str
    description: str
    icon: str
    system_prompt: str
    enabled: bool = True

class CategoryUpdateRequest(BaseModel):
    name: Optional[str] = None
    description: Optional[str] = None
    icon: Optional[str] = None
    system_prompt: Optional[str] = None
    enabled: Optional[bool] = None

async def create_audit_log(
    db: AsyncSession,
    admin: Admin,
    action: AuditAction,
    resource_type: str,
    resource_id: Optional[uuid.UUID],
    details: Optional[dict],
    request: Request
):
    """Helper function to create audit log entries"""
    audit_entry = AuditLog(
        admin_user_id=admin.admin_id,
        action=action,
        resource_type=resource_type,
        resource_id=resource_id,
        details=details,
        ip_address=request.client.host if request.client else None
    )
    db.add(audit_entry)

@router.get("/categories", response_model=List[CategoryResponse])
async def get_all_categories_admin(
    admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN, AdminRole.CONTENT_MANAGER, AdminRole.SYSTEM_MONITOR)),
    db: AsyncSession = Depends(get_db)
):
    """
    Get all counselor categories including disabled ones (admin only).
    """
    try:
        # Query all categories (no enabled filter)
        query = select(CounselorCategory)
        result = await db.execute(query)
        categories = result.scalars().all()
        
        return [
            CategoryResponse(
                category_id=str(cat.category_id),
                name=cat.name,
                description=cat.description,
                icon=cat.icon,
                system_prompt=cat.system_prompt,
                enabled=cat.enabled
            )
            for cat in categories
        ]
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Failed to fetch categories: {str(e)}")

@router.post("/categories", response_model=CategoryResponse)
async def create_category(
    category_data: CategoryCreateRequest,
    request: Request,
    admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN, AdminRole.CONTENT_MANAGER)),
    db: AsyncSession = Depends(get_db)
):
    """
    Create new counselor category (content manager or super admin).
    """
    try:
        # Validate system prompt length
        if len(category_data.system_prompt) > 5000:
            raise HTTPException(status_code=400, detail="System prompt exceeds 5000 character limit")
        
        # Create category
        new_category = CounselorCategory(
            category_id=uuid.uuid4(),
            name=category_data.name,
            description=category_data.description,
            icon=category_data.icon,
            system_prompt=category_data.system_prompt,
            enabled=category_data.enabled
        )
        
        db.add(new_category)
        
        # Create audit log
        await create_audit_log(
            db=db,
            admin=admin,
            action=AuditAction.CREATE,
            resource_type="CounselorCategory",
            resource_id=new_category.category_id,
            details={"name": category_data.name},
            request=request
        )
        
        await db.commit()
        await db.refresh(new_category)
        
        return CategoryResponse(
            category_id=str(new_category.category_id),
            name=new_category.name,
            description=new_category.description,
            icon=new_category.icon,
            system_prompt=new_category.system_prompt,
            enabled=new_category.enabled
        )
    except HTTPException:
        raise
    except Exception as e:
        await db.rollback()
        raise HTTPException(status_code=500, detail=f"Failed to create category: {str(e)}")

@router.put("/categories/{category_id}", response_model=CategoryResponse)
async def update_category(
    category_id: str,
    category_data: CategoryUpdateRequest,
    request: Request,
    admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN, AdminRole.CONTENT_MANAGER)),
    db: AsyncSession = Depends(get_db)
):
    """
    Update existing counselor category (content manager or super admin).
    """
    try:
        # Validate UUID
        try:
            cat_uuid = uuid.UUID(category_id)
        except ValueError:
            raise HTTPException(status_code=400, detail="Invalid category ID format")
        
        # Fetch category
        query = select(CounselorCategory).where(CounselorCategory.category_id == cat_uuid)
        result = await db.execute(query)
        category = result.scalar_one_or_none()
        
        if not category:
            raise HTTPException(status_code=404, detail="Category not found")
        
        # Track changes for audit log
        changes = {}
        
        # Update fields if provided
        if category_data.name is not None:
            changes["name"] = {"old": category.name, "new": category_data.name}
            category.name = category_data.name
        if category_data.description is not None:
            category.description = category_data.description
        if category_data.icon is not None:
            category.icon = category_data.icon
        if category_data.system_prompt is not None:
            if len(category_data.system_prompt) > 5000:
                raise HTTPException(status_code=400, detail="System prompt exceeds 5000 character limit")
            changes["system_prompt_updated"] = True
            category.system_prompt = category_data.system_prompt
        if category_data.enabled is not None:
            changes["enabled"] = {"old": category.enabled, "new": category_data.enabled}
            category.enabled = category_data.enabled
        
        # Create audit log
        await create_audit_log(
            db=db,
            admin=admin,
            action=AuditAction.UPDATE,
            resource_type="CounselorCategory",
            resource_id=category.category_id,
            details=changes,
            request=request
        )
        
        await db.commit()
        await db.refresh(category)
        
        return CategoryResponse(
            category_id=str(category.category_id),
            name=category.name,
            description=category.description,
            icon=category.icon,
            system_prompt=category.system_prompt,
            enabled=category.enabled
        )
    except HTTPException:
        raise
    except Exception as e:
        await db.rollback()
        raise HTTPException(status_code=500, detail=f"Failed to update category: {str(e)}")

@router.delete("/categories/{category_id}")
async def disable_category(
    category_id: str,
    request: Request,
    admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN, AdminRole.CONTENT_MANAGER)),
    db: AsyncSession = Depends(get_db)
):
    """
    Disable counselor category (soft delete by setting enabled=false).
    """
    try:
        # Validate UUID
        try:
            cat_uuid = uuid.UUID(category_id)
        except ValueError:
            raise HTTPException(status_code=400, detail="Invalid category ID format")
        
        # Fetch category
        query = select(CounselorCategory).where(CounselorCategory.category_id == cat_uuid)
        result = await db.execute(query)
        category = result.scalar_one_or_none()
        
        if not category:
            raise HTTPException(status_code=404, detail="Category not found")
        
        # Soft delete
        category.enabled = False
        
        # Create audit log
        await create_audit_log(
            db=db,
            admin=admin,
            action=AuditAction.DELETE,
            resource_type="CounselorCategory",
            resource_id=category.category_id,
            details={"name": category.name},
            request=request
        )
        
        await db.commit()
        
        return {"message": "Category disabled successfully"}
    except HTTPException:
        raise
    except Exception as e:
        await db.rollback()
        raise HTTPException(status_code=500, detail=f"Failed to disable category: {str(e)}")
```

### Frontend Counselor Management Page

**app/admin/counselors/page.tsx:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { useToast } from '@/components/ui/use-toast';
import { Edit, Trash2, Plus } from 'lucide-react';
import CategoryFormModal from '@/components/admin/CategoryFormModal';

interface Category {
  category_id: string;
  name: string;
  description: string;
  icon: string;
  system_prompt: string;
  enabled: boolean;
}

export default function CounselorManagementPage() {
  const { toast } = useToast();
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);

  const fetchCategories = async () => {
    try {
      const response = await fetch('/api/admin/counselors/categories', {
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Failed to fetch categories');
      }

      const data = await response.json();
      setCategories(data);
    } catch (error) {
      console.error('Error fetching categories:', error);
      toast({
        title: "Error",
        description: "Failed to load counselor categories",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCategories();
  }, []);

  const handleCreate = () => {
    setEditingCategory(null);
    setShowModal(true);
  };

  const handleEdit = (category: Category) => {
    setEditingCategory(category);
    setShowModal(true);
  };

  const handleDisable = async (category: Category) => {
    if (!confirm(`Disable "${category.name}"? Students will no longer see this category.`)) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/counselors/categories/${category.category_id}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (!response.ok) {
        throw new Error('Failed to disable category');
      }

      toast({
        title: "Category Disabled",
        description: `${category.name} has been disabled`
      });

      fetchCategories();
    } catch (error) {
      console.error('Error disabling category:', error);
      toast({
        title: "Error",
        description: "Failed to disable category",
        variant: "destructive"
      });
    }
  };

  const handleSave = async () => {
    setShowModal(false);
    toast({
      title: "Success",
      description: editingCategory ? "Category updated" : "Category created"
    });
    fetchCategories();
  };

  if (loading) {
    return <div className="p-6">Loading...</div>;
  }

  return (
    <div className="container mx-auto p-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Counselor Categories</CardTitle>
            <Button onClick={handleCreate}>
              <Plus className="mr-2 h-4 w-4" />
              Create Category
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Icon</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Description</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {categories.map((category) => (
                <TableRow key={category.category_id}>
                  <TableCell className="text-2xl">{category.icon}</TableCell>
                  <TableCell className="font-medium">{category.name}</TableCell>
                  <TableCell className="max-w-md truncate">{category.description}</TableCell>
                  <TableCell>
                    <Badge variant={category.enabled ? "default" : "secondary"}>
                      {category.enabled ? 'Enabled' : 'Disabled'}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    <div className="flex gap-2">
                      <Button
                        onClick={() => handleEdit(category)}
                        variant="outline"
                        size="sm"
                      >
                        <Edit className="h-4 w-4" />
                      </Button>
                      {category.enabled && (
                        <Button
                          onClick={() => handleDisable(category)}
                          variant="destructive"
                          size="sm"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {showModal && (
        <CategoryFormModal
          category={editingCategory}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
        />
      )}
    </div>
  );
}
```

### Category Form Modal Component

**components/admin/CategoryFormModal.tsx:**
```typescript
'use client';

import { useState, useEffect, FormEvent } from 'react';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { useToast } from '@/components/ui/use-toast';

interface Category {
  category_id: string;
  name: string;
  description: string;
  icon: string;
  system_prompt: string;
  enabled: boolean;
}

interface Props {
  category: Category | null;
  onClose: () => void;
  onSave: () => void;
}

export default function CategoryFormModal({ category, onClose, onSave }: Props) {
  const { toast } = useToast();
  const [name, setName] = useState('');
  const [description, setDescription] = useState('');
  const [icon, setIcon] = useState('');
  const [systemPrompt, setSystemPrompt] = useState('');
  const [enabled, setEnabled] = useState(true);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (category) {
      setName(category.name);
      setDescription(category.description);
      setIcon(category.icon);
      setSystemPrompt(category.system_prompt);
      setEnabled(category.enabled);
    }
  }, [category]);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const body = { name, description, icon, system_prompt: systemPrompt, enabled };
      const url = category
        ? `/api/admin/counselors/categories/${category.category_id}`
        : '/api/admin/counselors/categories';
      const method = category ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to save category');
      }

      onSave();
    } catch (error) {
      console.error('Error saving category:', error);
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to save category",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>{category ? 'Edit Category' : 'Create Category'}</DialogTitle>
          <DialogDescription>
            {category ? 'Update counselor category details' : 'Add a new counselor category'}
          </DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="name">Name</Label>
            <Input
              id="name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
              placeholder="Health Counselor"
            />
          </div>
          <div>
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              required
              placeholder="Support for physical and mental health concerns"
              rows={3}
            />
          </div>
          <div>
            <Label htmlFor="icon">Icon (Emoji)</Label>
            <Input
              id="icon"
              value={icon}
              onChange={(e) => setIcon(e.target.value)}
              required
              placeholder="ðŸ¥"
              maxLength={2}
            />
          </div>
          <div>
            <Label htmlFor="systemPrompt">System Prompt</Label>
            <Textarea
              id="systemPrompt"
              value={systemPrompt}
              onChange={(e) => setSystemPrompt(e.target.value)}
              required
              placeholder="You are a health counselor..."
              rows={8}
              className="font-mono text-sm"
            />
            <div className="text-xs text-gray-500 mt-1">
              {systemPrompt.length} / 5000 characters
            </div>
          </div>
          <div className="flex items-center space-x-2">
            <Switch
              id="enabled"
              checked={enabled}
              onCheckedChange={setEnabled}
            />
            <Label htmlFor="enabled">Enabled (visible to students)</Label>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={loading}>
              {loading ? 'Saving...' : 'Save'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

### Source Tree Updates

```
packages/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models.py                   # Add AuditLog model
â”‚   â””â”€â”€ routers/
â”‚       â””â”€â”€ admin_counselors.py     # New router

packages/frontend/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ counselors/
â”‚           â””â”€â”€ page.tsx            # Counselor management page
â””â”€â”€ components/
    â””â”€â”€ admin/
        â””â”€â”€ CategoryFormModal.tsx   # Form modal component
```

---

## Testing

### Testing Requirements:

1. **CRUD Operations Test:**
   ```python
   @pytest.mark.asyncio
   async def test_create_counselor_category(db_session, test_admin):
       """Test creating new counselor category"""
       token = create_admin_token(test_admin)
       
       response = client.post(
           "/api/admin/counselors/categories",
           json={
               "name": "Test Counselor",
               "description": "Test description",
               "icon": "ðŸ§ª",
               "system_prompt": "You are a test counselor",
               "enabled": True
           },
           cookies={"admin_token": token}
       )
       
       assert response.status_code == 200
       data = response.json()
       assert data["name"] == "Test Counselor"
   ```

2. **Audit Log Test:**
   ```python
   @pytest.mark.asyncio
   async def test_audit_log_created_on_category_update(db_session, test_admin, test_category):
       """Test that audit log is created on category modification"""
       token = create_admin_token(test_admin)
       
       response = client.put(
           f"/api/admin/counselors/categories/{test_category.category_id}",
           json={"name": "Updated Name"},
           cookies={"admin_token": token}
       )
       
       assert response.status_code == 200
       
       # Check audit log
       query = select(AuditLog).where(
           AuditLog.resource_id == test_category.category_id,
           AuditLog.action == AuditAction.UPDATE
       )
       result = await db_session.execute(query)
       audit_entry = result.scalar_one_or_none()
       
       assert audit_entry is not None
       assert audit_entry.admin_user_id == test_admin.admin_id
   ```

3. **Manual Testing Checklist:**
   - [ ] Admin can access /admin/counselors page
   - [ ] All categories displayed in table
   - [ ] Disabled categories visible with badge
   - [ ] "Create Category" button opens modal
   - [ ] Form validates required fields
   - [ ] System prompt character count displayed
   - [ ] System prompt limited to 5000 chars
   - [ ] Edit button opens modal with pre-filled data
   - [ ] Updates save successfully
   - [ ] Disable button confirms action
   - [ ] Disabled category hidden from students
   - [ ] Enabled toggle works correctly
   - [ ] Success toasts displayed
   - [ ] Error toasts for failures
   - [ ] Table refreshes after operations
   - [ ] Audit log entries created
   - [ ] Content manager can edit categories
   - [ ] System monitor cannot edit categories (403)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
