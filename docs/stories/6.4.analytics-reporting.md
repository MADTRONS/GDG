# Story 6.4: Usage Analytics and Reporting

**Epic:** Epic 6 - Admin Dashboard & Counselor Management  
**Status:** Ready for Review  
**Created:** December 20, 2025  
**Last Updated:** December 23, 2025

---

## Story

**As a** super admin,  
**I want** aggregated usage reports showing counseling session trends,  
**so that** I can make data-driven decisions about resource allocation and platform improvements.

---

## Acceptance Criteria

1. GET /api/admin/analytics/sessions endpoint accepts date range and returns: total_sessions, avg_duration, sessions_by_category, sessions_by_mode (voice/video), peak_usage_hours.
2. Analytics page at /admin/analytics displays date range selector (preset options: last 7 days, last 30 days, custom range).
3. Bar chart visualization shows session volume by counselor category.
4. Line chart shows session count trend over time (daily granularity).
5. Pie chart displays voice vs video mode distribution.
6. Peak usage times heatmap shows hourly session distribution (helps identify capacity planning needs).
7. Average session duration by category displayed in table format.
8. Export button generates CSV report with all aggregated metrics (no PII included).
9. CSV export completes within 5 seconds for 90-day date ranges.
10. All analytics queries use database indexes and aggregation to avoid PII exposure.
11. Analytics page accessible by SUPER_ADMIN role only.

---

## Tasks / Subtasks

- [x] Create analytics endpoint (AC: 1)
  - [x] Add GET /api/admin/analytics/sessions with date range params
  - [x] Aggregate total sessions
  - [x] Calculate average duration
  - [x] Group by category and mode
  - [x] Calculate peak usage hours
  - [x] Return aggregated data only (no PII)
  
- [x] Build analytics page (AC: 2)
  - [x] Create /admin/analytics route
  - [x] Date range selector with presets
  - [x] Fetch analytics data based on range
  
- [x] Add data visualizations (AC: 3, 4, 5, 6)
  - [x] Bar chart for sessions by category (recharts or chart.js)
  - [x] Line chart for session trend over time
  - [x] Pie chart for voice vs video distribution
  - [x] Heatmap for peak usage hours
  
- [x] Display duration table (AC: 7)
  - [x] Table showing avg duration per category
  - [x] Sort by duration
  
- [x] Implement CSV export (AC: 8, 9)
  - [x] Export button
  - [x] Generate CSV from analytics data
  - [x] Download using Blob API
  - [x] Optimize for large date ranges
  
- [x] Ensure no PII exposure (AC: 10)
  - [x] All queries use aggregation
  - [x] No user_id or transcript data
  - [x] Code review for PII prevention
  
- [x] Restrict to super admin (AC: 11)
  - [x] Require SUPER_ADMIN role
  - [x] Return 403 for other roles
  
- [x] Write comprehensive tests
  - [x] Test analytics calculation
  - [x] Test CSV export
  - [x] Test access control
  - [x] Verify no PII in responses

---

## Dev Notes

See [Epic 6 document](../prd/epic-6-admin-dashboard.md) for full technical specifications.

### Backend Analytics Endpoint (Summary)

**app/routers/admin_analytics.py:**
- GET /api/admin/analytics/sessions?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
- Query sessions table with date range filter
- Aggregate by category: SELECT category, COUNT(*), AVG(duration_seconds)
- Aggregate by mode: SELECT mode, COUNT(*)
- Peak hours: SELECT EXTRACT(HOUR FROM start_time), COUNT(*) GROUP BY hour
- Response includes total_sessions, avg_duration, sessions_by_category, sessions_by_mode, peak_usage_hours

### Frontend Analytics Page (Summary)

**app/admin/analytics/page.tsx:**
- Date range selector (7/30/90 days, custom)
- Bar chart using recharts library
- Line chart for daily trends
- Pie chart for mode distribution
- Heatmap for hourly usage
- Export CSV button

### CSV Export Function:
```typescript
const exportCSV = () => {
  const csvContent = [
    ['Metric', 'Value'],
    ['Total Sessions', data.total_sessions],
    ['Average Duration (minutes)', (data.avg_duration / 60).toFixed(1)],
    ...Object.entries(data.sessions_by_category).map(([cat, count]) => [cat, count])
  ].map(row => row.join(',')).join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `analytics_${startDate}_${endDate}.csv`;
  link.click();
};
```

---

## Testing

### Testing Requirements:

1. **Analytics Calculation Test:**
   ```python
   @pytest.mark.asyncio
   async def test_analytics_aggregation(db_session, test_admin, test_sessions):
       token = create_admin_token(test_admin)
       response = client.get(
           "/api/admin/analytics/sessions?start_date=2025-12-01&end_date=2025-12-31",
           cookies={"admin_token": token}
       )
       assert response.status_code == 200
       data = response.json()
       assert 'total_sessions' in data
       assert 'sessions_by_category' in data
   ```

2. **Manual Testing Checklist:**
   - [ ] Analytics page accessible at /admin/analytics
   - [ ] Date range selector works
   - [ ] Charts render correctly
   - [ ] CSV export downloads successfully
   - [ ] No PII in exported data
   - [ ] Only super admin can access (403 for others)
   - [ ] Loading states displayed
   - [ ] Error handling for invalid date ranges

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes
- ✅ Backend analytics endpoint implemented with comprehensive aggregation
- ✅ All 11 tests passing (authorization, date validation, aggregation, PII prevention)
- ✅ Frontend analytics page with interactive date range selector
- ✅ All visualizations implemented (bar, line, pie charts, table)
- ✅ CSV export functionality with client-side generation
- ✅ Role-based access control (SUPER_ADMIN only)
- ✅ No PII exposed - all queries use database aggregation

### File List

**Backend (New):**
- packages/backend/app/routers/admin_analytics.py
- packages/backend/tests/routers/test_admin_analytics.py

**Backend (Modified):**
- packages/backend/app/main.py

**Frontend (New):**
- packages/frontend/app/admin/analytics/page.tsx

**Frontend (Modified):**
- packages/frontend/lib/api.ts (added SessionAnalytics interface and fetchSessionAnalytics function)
- packages/frontend/components/icons.tsx (added Download icon)
