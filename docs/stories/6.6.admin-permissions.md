# Story 6.6: Admin Permissions and Role Management

**Epic:** Epic 6 - Admin Dashboard & Counselor Management  
**Status:** Draft  
**Created:** December 20, 2025  
**Last Updated:** December 20, 2025

---

## Story

**As a** super admin,  
**I want** to create admin accounts with specific roles and permissions,  
**so that** I can grant appropriate access levels to different team members.

---

## Acceptance Criteria

1. GET /api/admin/users endpoint returns list of all admin users (SUPER_ADMIN only).
2. POST /api/admin/users endpoint creates new admin user with email, initial password, and role (SUPER_ADMIN only).
3. PUT /api/admin/users/{id} endpoint updates admin user role or active status (SUPER_ADMIN only).
4. DELETE /api/admin/users/{id} soft deletes admin user (sets is_active=false, SUPER_ADMIN only).
5. Admin user management page at /admin/users displays table of admins with email, role, status, last login.
6. Create admin form includes email validation, role dropdown, and temporary password generation.
7. Password reset functionality allows admins to reset their own password.
8. Super admins can force password reset for other admin users.
9. Role-based access control enforced: CONTENT_MANAGER can only edit counselor categories, SYSTEM_MONITOR is read-only for metrics, SUPER_ADMIN has full access.
10. Attempting unauthorized action returns 403 Forbidden with clear error message.
11. Unit tests verify permission enforcement for all role combinations.

---

## Tasks / Subtasks

- [ ] Create admin user management endpoints (AC: 1, 2, 3, 4)
  - [ ] GET /api/admin/users (list all admins)
  - [ ] POST /api/admin/users (create new admin)
  - [ ] PUT /api/admin/users/{id} (update role/status)
  - [ ] DELETE /api/admin/users/{id} (soft delete)
  - [ ] All require SUPER_ADMIN role
  
- [ ] Build admin user management page (AC: 5)
  - [ ] Create /admin/users route
  - [ ] Display table with email, role, status, last login
  - [ ] "Create Admin" button
  
- [ ] Create admin form (AC: 6)
  - [ ] Email input with validation
  - [ ] Role dropdown (SUPER_ADMIN, SYSTEM_MONITOR, CONTENT_MANAGER)
  - [ ] Auto-generate temporary password
  - [ ] Display generated password to super admin
  
- [ ] Implement password reset (AC: 7, 8)
  - [ ] Endpoint: PUT /api/admin/auth/reset-password
  - [ ] Admins can reset own password
  - [ ] Super admins can force reset for others
  
- [ ] Verify role-based access (AC: 9)
  - [ ] CONTENT_MANAGER: can access /admin/counselors only
  - [ ] SYSTEM_MONITOR: read-only access to /admin/dashboard and /admin/metrics
  - [ ] SUPER_ADMIN: full access to all routes
  
- [ ] Error handling (AC: 10)
  - [ ] Return 403 for insufficient permissions
  - [ ] Clear error messages
  
- [ ] Write comprehensive tests (AC: 11)
  - [ ] Test role permission enforcement
  - [ ] Test CRUD operations for admin users
  - [ ] Test password reset
  - [ ] Test 403 errors for unauthorized actions

---

## Dev Notes

**Note:** Admin model and authentication already implemented in Story 6.1.

See [Story 6.1](6.1.admin-authentication.md) for Admin model and auth functions.

### Admin User Management Router

**app/routers/admin_users.py (new file):**
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from app.database import get_db
from app.models import Admin, AdminRole
from app.auth import require_admin_role
from pydantic import BaseModel, EmailStr
import bcrypt
import secrets
import uuid

router = APIRouter(prefix="/admin/users", tags=["admin-users"])

class AdminUserResponse(BaseModel):
    admin_id: str
    email: str
    role: str
    is_active: bool
    last_login_at: str | None

class CreateAdminRequest(BaseModel):
    email: EmailStr
    role: AdminRole

class CreateAdminResponse(BaseModel):
    admin_id: str
    email: str
    role: str
    temporary_password: str

def generate_temp_password() -> str:
    """Generate secure temporary password"""
    return secrets.token_urlsafe(16)

@router.get("", response_model=list[AdminUserResponse])
async def list_admin_users(
    current_admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN)),
    db: AsyncSession = Depends(get_db)
):
    """List all admin users (super admin only)"""
    query = select(Admin)
    result = await db.execute(query)
    admins = result.scalars().all()
    
    return [
        AdminUserResponse(
            admin_id=str(admin.admin_id),
            email=admin.email,
            role=admin.role.value,
            is_active=admin.is_active,
            last_login_at=admin.last_login_at.isoformat() if admin.last_login_at else None
        )
        for admin in admins
    ]

@router.post("", response_model=CreateAdminResponse)
async def create_admin_user(
    data: CreateAdminRequest,
    current_admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN)),
    db: AsyncSession = Depends(get_db)
):
    """Create new admin user (super admin only)"""
    # Check if email already exists
    existing_query = select(Admin).where(Admin.email == data.email.lower())
    existing_result = await db.execute(existing_query)
    if existing_result.scalar_one_or_none():
        raise HTTPException(status_code=400, detail="Email already exists")
    
    # Generate temporary password
    temp_password = generate_temp_password()
    password_hash = bcrypt.hashpw(temp_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    
    # Create admin
    new_admin = Admin(
        admin_id=uuid.uuid4(),
        email=data.email.lower(),
        password_hash=password_hash,
        role=data.role,
        is_active=True
    )
    
    db.add(new_admin)
    await db.commit()
    await db.refresh(new_admin)
    
    return CreateAdminResponse(
        admin_id=str(new_admin.admin_id),
        email=new_admin.email,
        role=new_admin.role.value,
        temporary_password=temp_password
    )

@router.put("/{admin_id}")
async def update_admin_user(
    admin_id: str,
    role: AdminRole | None = None,
    is_active: bool | None = None,
    current_admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN)),
    db: AsyncSession = Depends(get_db)
):
    """Update admin user role or status (super admin only)"""
    query = select(Admin).where(Admin.admin_id == uuid.UUID(admin_id))
    result = await db.execute(query)
    admin = result.scalar_one_or_none()
    
    if not admin:
        raise HTTPException(status_code=404, detail="Admin not found")
    
    if role is not None:
        admin.role = role
    if is_active is not None:
        admin.is_active = is_active
    
    await db.commit()
    return {"message": "Admin updated successfully"}

@router.delete("/{admin_id}")
async def deactivate_admin_user(
    admin_id: str,
    current_admin: Admin = Depends(require_admin_role(AdminRole.SUPER_ADMIN)),
    db: AsyncSession = Depends(get_db)
):
    """Deactivate admin user (super admin only)"""
    query = select(Admin).where(Admin.admin_id == uuid.UUID(admin_id))
    result = await db.execute(query)
    admin = result.scalar_one_or_none()
    
    if not admin:
        raise HTTPException(status_code=404, detail="Admin not found")
    
    # Prevent deactivating self
    if admin.admin_id == current_admin.admin_id:
        raise HTTPException(status_code=400, detail="Cannot deactivate yourself")
    
    admin.is_active = False
    await db.commit()
    return {"message": "Admin deactivated successfully"}
```

### Frontend Admin Users Page

**app/admin/users/page.tsx:**
```typescript
'use client';

import { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Plus } from 'lucide-react';
import CreateAdminModal from '@/components/admin/CreateAdminModal';
import { format } from 'date-fns';

interface AdminUser {
  admin_id: string;
  email: string;
  role: string;
  is_active: boolean;
  last_login_at: string | null;
}

export default function AdminUsersPage() {
  const [admins, setAdmins] = useState<AdminUser[]>([]);
  const [showModal, setShowModal] = useState(false);

  const fetchAdmins = async () => {
    const response = await fetch('/api/admin/users', { credentials: 'include' });
    if (response.ok) {
      setAdmins(await response.json());
    }
  };

  useEffect(() => {
    fetchAdmins();
  }, []);

  return (
    <div className="container mx-auto p-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Admin Users</CardTitle>
            <Button onClick={() => setShowModal(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Create Admin
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Email</TableHead>
                <TableHead>Role</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Last Login</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {admins.map((admin) => (
                <TableRow key={admin.admin_id}>
                  <TableCell className="font-medium">{admin.email}</TableCell>
                  <TableCell>
                    <Badge variant="outline">{admin.role}</Badge>
                  </TableCell>
                  <TableCell>
                    <Badge variant={admin.is_active ? "default" : "secondary"}>
                      {admin.is_active ? 'Active' : 'Inactive'}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    {admin.last_login_at
                      ? format(new Date(admin.last_login_at), 'MMM d, yyyy')
                      : 'Never'}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
      {showModal && (
        <CreateAdminModal
          onClose={() => setShowModal(false)}
          onSuccess={fetchAdmins}
        />
      )}
    </div>
  );
}
```

---

## Testing

### Testing Requirements:

1. **Permission Enforcement Test:**
   ```python
   def test_content_manager_cannot_access_users(test_content_manager):
       token = create_admin_token(test_content_manager)
       response = client.get(
           "/api/admin/users",
           cookies={"admin_token": token}
       )
       assert response.status_code == 403
   ```

2. **Manual Testing Checklist:**
   - [ ] Admin users page accessible at /admin/users
   - [ ] Only super admin can access
   - [ ] Create admin button opens modal
   - [ ] New admin created with temp password
   - [ ] Temp password displayed to super admin
   - [ ] Admin roles enforced correctly
   - [ ] Content manager limited to counselor edits
   - [ ] System monitor read-only access
   - [ ] Super admin full access
   - [ ] Cannot deactivate self
   - [ ] 403 errors for unauthorized actions

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-20 | 1.0 | Initial story creation | Sarah (PO) |
